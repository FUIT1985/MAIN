                          Servizi di Rete: Post x, Apache, NFS,
                          Samba, Squid, LDAP, SIP, XMPP, TURN
                          11. Servizi di rete
                                                     Capitolo 11                                                                      pag. 251
                                     1. Mail Server [I servers che si occupano della posta elettronica]                               pag. 252
                                                1. Installazione di Post x                                                            pag. 252
                                                2. Con gurazione dei Virtual Domains                                                  pag. 255
                                                            1. Virtual Alias Domains                                                  pag. 255
                                                            2. Virtual Mailbox Domains                                                pag. 256
                                                3. Restrizioni per la Ricezione e la Trasmissione                                     pag. 257
                                                            1. Come limitare l’accesso in base all’indirizzo IP                       pag. 258
                                                            2. Veri ca della legittimità attraverso il comando EHLO o HELO            pag. 259
                                                            3. Consenso o diniego in base al Mittente Annunciato                      pag. 260
                                                            4. Consenso o diniego in base al Destinatario                             pag. 260
                                                            5. Restrizioni relative al comando DAT                                    pag. 261
                                                            6. Messa in atto delle restrizioni                                        pag. 261
                                                            7. Filtraggio basato sul contenuto del messaggio                          pag. 261
                                                4. Con gurazione: greylisting                                                         pag. 262
                                                5. Personalizzazione dei ltri in base al destinatario                                 pag. 264
                                                6. Integrazione di un antivirus                                                       pag. 265
                                                7. Autenticated SMTP                                                                  pag. 266
                                     2. Server Web (HTTP)                                                                             pag. 268
                                                1. Installazione di Apache                                                            pag. 268
                                                2. Con gurazione dei Virtual Hosts                                                    pag. 269
                                                3. Common Directives (Le direttive maggiormente utilizzate)                           pag. 271
                                                            1. Come richiedere l’Autenticazione                                       pag. 272
                                                            2. Come limitare l’Accesso                                                pag. 272
                                                4. Log Analyzers                                                                      pag. 273
                                     3. FTP File Server                                                                               pag. 275
                                     4. NFS File Server                                                                               pag. 276
                                                1. Securing NFS [come con gurare le funzionalità di sicurezza di NFS]                 pag. 277
                                                2. NFS Server                                                                         pag. 277
                                                3. NFS Client                                                                         pag. 278
                                     5. Con gurare Windows Shares attraverso Samba                                                    pag. 279
                                                1. Samba Server                                                                       pag. 279
                                                            1. Con gurazione con debconf                                              pag. 279
                                                            2. Con gurazione manuale                                                  pag. 280
                                                                        1. Le modi che a smb.conf                                     pag. 280
                                                                        2. Come aggiungere gli Utenti                                 pag. 281
                                                2. Samba Client                                                                       pag. 281
                                                            1. Il programma smbclient                                                 pag. 281
                                                            2. Mounting delle Windows Shares                                          pag. 281
                                                            3. Come stampare su una stampante condivisa                               pag. 282
                                     6. Proxy HTTP/FTP                                                                                pag. 282
                                                1. Installazione                                                                      pag. 282
                                                2. Con gurazione di una cache                                                         pag. 283
                                                3. Come con gurare un ltro                                                            pag. 283
                                     7. LDAP Directory                                                                                pag. 284
                                                1. Installazione                                                                      pag. 284
                                                2. Compilazione nella directory                                                       pag. 286
                                                3. La gestione degli Accounts con LDAP                                                pag. 287
                                                            1. Come con gurare NSS                                                    pag. 287
                                                            2. Come con gurare PAM                                                    pag. 288
                                                            3. Come proteggere lo Scambio Dati di LDAP                                pag. 289
                                                                        1. Con gurazione lato server                                  pag. 289
                                                                        2. Con gurazione lato client                                  pag. 291
                                     8. Real-Time Communication Service                                                               pag. 292
                                                1. Impostazioni DNS per i servizi RTC                                                 pag. 293
                                                2. TURN server                                                                        pag. 293
                                                            1. Installazione del TURN server                                          pag. 294
                                                            2. TURN gestione utenti                                                   pag. 294
                                                3. SIP Proxy Server [Session Initiation Protocol]                                     pag. 294
                                                            1. Installazione del SIP proxy                                            pag. 294
                                                            2. Come gestire il SIP proxy                                              pag. 296
                                                4. XMPP Server                                                                        pag. 296
                                                            1. Installazione del XMPP server                                          pag. 296
                                                            2. Come gestire il server XMPP                                            pag. 297
                                                5. Come eseguire i servizi sul port 443                                               pag. 297
                                                6. Come aggiungere un servizio WebRTC                                                 pag. 298


                          <<Vengono de niti servizi di rete (network services in ingl.) i programmi con cui gli utenti
                          interagiscono direttamente per lo svolgimento delle loro mansioni quotidiane. I servizi di rete rappresentano la
                          punta dell'iceberg di un sistema informativo pertanto questo capitolo li tratterà in dettaglio; le componenti
                          celate su cui si basano i servizi di rete rappresentano l’infrastruttura che è stata descritta precedentemente.
                          Diversi servizi di rete necessitano di essere supportati da una tecnologia di crittogra a per poter essere eseguiti
                          in modo af dabile e sicuro, soprattutto se utilizzati su Internet (o su una rete pubblica). I Certi cati X.509
                          (correlati a Certi cati SSL oppure a Certi cati TLS) vengono comunemente utilizzati a questo scopo. Un
                          certi cato relativo ad un dato dominio può essere spesso condiviso tra più servizi, in particolare fra i servizi
                          presentati in questo capitolo.>>
fi
fi
fi
 fi
 fi
 fi
 fi
 fi
 fi
 fi
      fi
           fi
                fi
                fi
                fi
                     fi
                          fi
                               fi
                                    fi
                                         fi
                                              fi
                                                   fi
                                                        A

                                                              fi
                                                                                   fi
                                                                                                                      fi
                                                                                                                             fi
                              11.1. Mail Server [I servers che si occupano della posta elettronica]

                              Gli amministratori della Falcot Corp hanno scelto Post x come mail server per la sua semplicità di
                              con gurazione ed af dabilità. In effetti Post x è stato designato in modo da garantire che ogni
                              attività venga implementata in un processo con una titolarità dei diritti e dei permessi strettamente
                              necessaria allo scopo da ridurre l’adozione ex post di provvedimenti per contrastare potenziali
                              vulnerabilità di sicurezza.

                                   ALTERNATIVA                          Debian include Exim4 come mail server prede nito (e quest’ultimo viene pertanto
                                                                        installato automaticamente durante l'installazione iniziale). La con gurazione di
                               Il server Exim4
                                                                        Exim4 viene supportata da un altro distinto pacchetto denominato exim4-config
                                                                        ed automaticamente personalizzata tramite una serie di domande debconf molto
                                                                        simili a quelle poste dal pacchetto di postfix.
                                                                        La suddetta con gurazione può essere salvata in un unico le (/etc/exim4/
                                                                        exim4.conf.template) oppure frammentata in diversi configuration snippets
                                                                         les conservati nella directory /etc/exim4/conf.d/ [snippets in inglese
                                                                        signi ca appunto frammenti e genericamente si riferiscono a piccole porzioni di
                                                                        codice, in particolare destinate alla programmazione modulare]. In entrambi i
                                                                        casi, i les vengono utilizzati dal comando update-exim4.conf come modelli per
                                                                        generare /var/lib/exim4/config.autogenerated. Exim4 utilizza quest’ultimo
                                                                         le. Per mezzo di questo meccanismo, i valori ottenuti dalla con gurazione debconf
                                                                        di Exim (memorizzati in /etc/exim4/update-exim4.conf.conf) possono essere
                                                                        iniettati nel le di con gurazione di Exim, anche qualora l'amministratore o un
                                                                        altro pacchetto abbia modi cato la con gurazione Exim prede nita.
                                                                        La sintassi di con gurazione di Exim4 è piuttosto speci ca e richiede del tempo per
                                                                        padroneggiarla; ciò nonostante, una volta acquisite le dovute competenze, potrete
                                                                        usufruire di un server di posta solido e completo come del resto avrete modo di
                                                                        accertarvene nella decina di pagine di documentazione.

                                                                              http://www.exim.org/docs.html



                              11.1.1. Installazione di Post x

                              Il pacchetto postfix contiene il main SMTP daemon. Altri pacchetti (come ad esempio postfix-
                              ldap o postfix-pgsql) concedono funzionalità aggiuntive a Post x, incluso l’accesso ai mapping
                              databases. [In generale il mapping è una tecnica di gestione dei dati (per poter eseguire una
                              migrazione, integrazione, ecc), che consente l’estrazione dei dati dei campi (in inglese fields) di un
                              database ed il loro indirizzamento ai campi corrispondenti di altri database target. Pertanto,
                              genericamente, i databases i cui dati vengono fra loro indirizzati attraverso questa tecnica possono
                              essere de niti mapping databases]. Installate le funzionalità aggiuntive solo se ne avete necessità.
                                                                        SMTP (Simple Mail Transfer Protocol) è il protocollo utilizzato dai mail servers per
                                           BASILARE
                                                                        scambiarsi ed instradare le emails.
                              SMTP

                              Durante l'installazione del pacchetto vengono poste diverse domande Debconf. Le risposte
                              genereranno una prima versione del le di con gurazione /etc/postfix/main.cf.
                              La prima domanda riguarda il tipo di installazione. Delle scelte proposte, solo due sono rilevanti per
                              un server connesso ad Internet: “Internet site” e “Internet with smarthost”. La prima scelta
                              è adatta ad un server che riceve la posta in entrata ed invia la posta in uscita direttamente ai suoi
                              destinatari, modalità conforme al case degli amministratori della Falcot Corp. La seconda scelta è
                              invece adatta ad un server che riceve la posta in entrata direttamente, ma invia la posta in uscita
                              tramite un server SMTP intermedio, denominato smarthost, anziché al server dei rispettivi
                              destinatari. Quest’ultima scelta è particolarmente utile per le persone con un indirizzo IP dinamico,
                              in quanto molti mail servers ri utano qualsiasi messaggio proveniente direttamente da un indirizzo
                              IP dinamico. Lo smarthost indicato per la summenzionata con gurazione solitamente corrisponde al
                              server SMTP di un provider di servizi Internet (ISP), a sua volta con gurato per accettare sempre le
                              emails in entrata dai clienti dello stesso provider di servizi per poi inoltrane la posta
                              appropriatamente.




                              Pagina 252 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
fi
     fi
          fi
               fi
                    fi
                         fi
                                fi
                                     fi
                                          fi
                                               fi
                                                    fi
                                                         fi
                                                              fi
                                                                   fi
                                                                         fi
                                                                                 fi
                                                                                      fi
                                                                                           fi
                                                                                                fi
                                                                                                     fi
                                                                                                          fi
                                                                                                               fi
                                                                                                                    fi
                                                                                                                         fi
                                                                                                                              fi
                                                                                                                                   fi
                                                                                                                                        fi
               Di conseguenza la con gurazione di uno smarthost interesserà particolarmente i servers non
               permanentemente connessi, così che non sia necessaria la gestione di code di messaggi “non inviati”
               nonché la loro ritrasmissione successiva.


                        DIZIONARIO        [Il termine inglese ISP viene tradotto in francese in FAI, acronimo di Fournisseur
                ISP                       d’Accès à Internet, da non confondere con FAI, acronimo di Fully Automatic
                                          Installer trattato a pag. 339]
                                          ISP è l'abbreviazione di "Internet Service Provider". Si tratta di un'ente, spesso una
                                          società commerciale, che distribuisce connessioni ad Internet nonché i servizi di
                                          base associati (posta elettronica, news, ecc.). [Tra gli ISP francesi occorre citare
                                          Free, Orange (ex-Wanadoo), SFR, AOL, FDN, ecc.]

               La seconda domanda riguarda il full name della macchina, utilizzato per generare gli indirizzi email
               degli utenti locali in combinazione con il loro nome account; il full name della macchina corrisponde
               alla parte che segue la "@" (chiocciola) nell’indirizzo email. Per la Falcot la risposta prescelta è
               mail.falcot.com. Questa è l'unica domanda richiesta di default, ma non è suf ciente per generare
               una con gurazione soddisfacente per le esigenze della Falcot Corp, pertanto i suoi amministratori
               decidono di eseguire il comando dpkg-reconfigure postfix in modo da poter personalizzare più
               parametri.
               Nello speci co una delle domande aggiuntive richiede agli amministratori di inserire tutti i domain
               names associati alla macchina. L'elenco di default proposto per la macchina include un full name
               nonché i synonyms (localhost), ma non il main domain falcot.com, che deve essere aggiunto
               manualmente. In generale, è opportuno indicare tutti i domain name per i quali la macchina dovrà
               svolgere il compito di MX server [Mail eXchanger]; in altre parole tutti i domain names che il DNS
               dovrà de nire af nché la macchina sia in grado di accettare le emails. Le informazioni immesse
               vengono poi memorizzate nella variabile mydestination del main Postfix configuration file
               - /etc/postfix/main.cf . [La funzionalità synonym (implementata attraverso il le /etc/hosts)
               consente di associare all’indirizzo IP di servizio 127.0.0.1 - che le macchine usano per ragioni di
               test o meramente per interpellare se stesse - il nome localhost, più agevole da ricordare rispetto ad
               una sequenza numerica.]




                                      Figura 11.1 Il ruolo del DNS MX record durante l'invio di una mail
                          TDAH_1.0   Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 253
fi
     fi
          fi
                   fi
                          fi
                                          fi
                                                                                             fi
                                                                                                  fi
                     EXTRA                       Se il DNS server non possiede un MX record per un dato dominio, l’email server
           Interrogazione                        [considererà il suddetto dominio come se fosse il target hostname con un preference
           (querying) dei                        value (priority) pari a 0 e] tenterà di inviare i messaggi direttamente all’host
                                                 stesso, ricercando l’equivalente record di tipo A se IPv4 o AAAA se IPv6. [RFC 5321
           MX records                            sec. 5.1, 5.2]



          A seconda dei casi, l'installazione potrebbe anche richiedere di indicare le reti autorizzate ad inviare
          posta tramite la macchina. Per impostazione prede nita, Post x accetta soltanto le emails
          provenienti dalla macchina stessa; occorre comunemente aggiungere la rete locale. Gli
          amministratori della Facolt Corp hanno aggiunto alla con gurazione prede nita 192.168.0.0/16.
          Se la domanda non viene posta durante l’installazione, dovrete modi care la correlata variabile
          mynetworks, come mostrato nell'esempio sottostante.
          Potrete af dare la consegna delle emails locali al tool procmail. Questo strumento consente agli
          utenti di ordinare la posta in arrivo stabilendo delle regole nel loro rispettivo le ~/.procmailrc.
          Dopo questa prima fase, gli amministratori hanno ottenuto il seguente le di con gurazione, che
          fungerà per i paragra seguenti da punto di partenza per attivare attraverso delle modi che
          determinate funzionalità aggiuntive.


                                                   Esempio 11.1 Il le /etc/postfix/main.cf (iniziale)

          # See /usr/share/postfix/main.cf.dist for a commented, more complete versio


          # Debian specific: Specifying a file name will cause the first
          # line of that file to be used as the name. The Debian default
          # is /etc/mailname
          #myorigin = /etc/mailnam


          smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU
          biff = n

          # appending .domain is the MUA’s job
          append_dot_mydomain = n

          # Uncomment the next line to generate ”delayed mail” warnings
          #delay_warning_time = 4

          readme_directory = n

          # TLS parameters
          smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
          smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
          smtpd_use_tls=ye
          smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
          smtp_tls_session_cache_database = btree:${data_directory}/smtp_scach


          # See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
          # information on enabling SSL in the smtp client.




          Pagina 254 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
     o

            fi
                    

                   s

                        fi
                             .

                                  o

                                       h

                                       o

                                            e

                                                           .

                                                                 fi
                                                                        fi
                                                                             fi
                                                                                    fi
                                                                                         )

                                                                                               

                                                                                               fi
                                                                                                     

                                                                                                         fi
                                                                                                              fi
                                                                                                                    

                                                                                                                    

                                                                                                                        fi
                                                                                                                             e

                                                                                                                                  fi
                                                                                                                                        

                                                                                                                                            n

      smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated
      -> defer_unauth_destinatio
      myhostname = mail.falcot.co
      alias_maps = hash:/etc/aliase
      alias_database = hash:/etc/aliase
      myorigin = /etc/mailnam
      mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
      relayhost
      mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
      mailbox_command = procmail -a ”$EXTENSION
      mailbox_size_limit =
      recipient_delimiter =
      inet_interfaces = al
      inet_protocols = al


                     SICUREZZA                                       Vengono soprannominati snake oil [dall'espressione inglese snake oil - olio di
               Snake oil -                                           serpente] i certi cati che non hanno alcuna ef cacia al pari dei medicinali a base di
               Certi cati SSL                                        “olio di serpente” venduti in passato dai ciarlatani: non potrete fare af damento su
                                                                     di essi per autenticare il server perché sono certi cati auto rmati e generati
                                                                     automaticamente. Tuttavia, sono utili per migliorare la riservatezza degli scambi.
                                                                     Dovrebbero essere usati solo a scopo di test, mentre per i servizi ordinari si
                                                                     dovrebbero usare certi cati reali; potrete generare quest’ultimi seguendo la
                                                                     procedura descritta nel paragrafo 10.2.1.1, "Infrastruttura a chiave pubblica: easy-
                                                                     rsa" a pagina 224.



      11.1.2. Con gurazione dei Virtual Domains

      Un server di posta elettronica può ricevere emails anche da altri domini e non solo dal dominio
      principale; questi domini alternativi vengono de niti virtual domains. Quando ciò avviene
      raramente le emails sono destinate agli utenti locali. Post x include due sorprendenti funzionalità
      per la gestione dei domini virtuali.

                   ATTENZIONE                                        Nessun virtual domains può essere indicato nella variabile mydestination;
               Virtual domains                                       questa variabile contiene solo i nomi dei domini "canonici", direttamente associati
               e canonical                                           alla macchina e ai suoi utenti locali.
                                                                     [non bisogna confondere il termine canonical domain con il dns record CNAME,
               domains
                                                                     proibito per i domini che usano SMPT MAIL ed i RCPT command (ex RFC 1123 sec.
                                                                     5.2.2). Il dns record CNAME contiene l’alias alla sinistra ed il canonical name alla
                                                                     destra. Il CNAME non può puntare direttamente ad un altro CNAME o ad un
                                                                     indirizzo IP, ma ad un domain name che deve essere tradotto in base al value A (in
                                                                     un indirizzo IPv4) o in base al value AAAA (in un indirizzo IPv6)]



      11.1.2.1 Virtual Alias Domains

      Un Virtual Alias Domains contiene solo aliases, ovvero indirizzi che inoltrano le emails ad altri
      indirizzi.
      Per attivare un virtual alias domain dovrete aggiungere il suo nome nella variabile
      virtual_alias_domains e speci care un address mapping file nella variabile
      virtual_alias_maps.




                          TDAH_1.0                   Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 255
fi
     fi
          =

                fi
                     fi
                            l

                                 l

                                      0

                                           +

                                                e

                                                      n

                                                           fi
                                                                m

                                                                     fi
                                                                          s

                                                                               fi
                                                                                s

                                                                                     fi
                                                                                          fi
                                                                                               ”

                                                                                                    fi
                                                                                                         fi
                                                                                                              fi
                                                                                                                                 

                             Esempio 11.2 Le direttive che dovrete aggiungere nel le /etc/postfix/main.c

          virtual_alias_domains = falcotsbrand.com
          virtual_alias_maps = hash:/etc/postfix/virtua

          Il le /etc/postfix/virtual de nisce il mapping attraverso una sintassi piuttosto inequivocabile.
          Ogni riga contiene due campi separati da una whitespace; il primo campo riporta l’alias name,
          mentre il secondo campo l’elenco degli indirizzi di posta elettronica a cui l’alias name rimanda. La
          special syntax [sintassi che usufruisce di caratteri speciali] @domain.com si occupa di tutti gli alias
          rimanenti di un dominio [nello speci co esempio sottostante la sintassi speciale viene utilizzata per
          inoltrare le email inviate al dominio @falcotsbrand.com agli account utenti omonimi del dominio
          @falcot.com]

                                                    Esempio 11.3 Esempio del le /etc/postfix/virtual

          webmaster@falcotsbrand.com jean@falcot.com
          contact@falcotsbrand.com laure@falcot.com, sophie@falcot.com
          # The alias below is generic and covers all addresses withi
          # the falcotsbrand.com domain not otherwise covered by this file.
          # These addresses forward email to the same user name in th
          # falcot.com domain
          @falcotsbrand.com @falcot.co


          11.1.2.2 Virtual Mailbox Domains


                ATTENZIONE                     Post x non consente di includere lo stesso dominio nelle variabili virtual_alias
           Le variabili Virtual                _domains e virtual_mailbox_domains. Tuttavia, i domini inclusi nella varibiale
           Alias domains e                     virtual_mailbox_domains verranno implicitamente considerati anche
           Virtual Mailbox                     virtual_alias_domains, consentendovi di poter usufruire allo stesso tempo sia di
           domains sono                        aliases, sia di mailboxes in un unico virtual domain.
           compatibili?



          Le emails destinate ad un virtual mailbox domain vengono salvate nelle mailboxes non assegnate
          agli utenti locali del sistema.
          Per attivare un virtual mailbox domain dovrete aggiungerlo alla variabile
          virtual_mailbox_domains e speci care il mailbox mapping le nella variabile
          virtual_mailbox_maps. Il parametro virtual_mailbox_base de nisce la directory in cui
          verranno archiviate le diverse mailboxes.
          Il le che contiene il mapping fra l’indirizzo email ed un utente di sistema o un gruppo di sistema,
          titolare/i dei diritti e dei permessi della mailbox, viene de nito rispettivamente nel parametro
          virtual_uid_maps o nel parametro virtual_gid_maps. Per assegnare di default tutte le mailboxes
          ad un unico utente/gruppo proprietario [con un uid e gid non in con itto con quelli degli altri utenti/
          gruppi del sistema] dovrete utilizzare la sintassi static:5000 sia nel parametro
          virtual_uid_maps, sia nel parametro virtual_gid_maps.




          Pagina 256 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
fi
     fi
                       fi
                        .

                                     fi
                                          m

                                               fi
                                               fi
                                                              fi
                                                                    

                                                                         

                                                                             l

                                                                                  fi
                                                                                       fi
                                                                                            fi
                                                                                            fl
                                                                                                 f

                                                                                                      n

                                                                                                      e

                                                                                                            

                                                                                                                 

                                  Esempio 11.4 Le direttive che dovrete aggiungere nel le /etc/postfix/main.cf

           virtual_mailbox_domains = falcot.org
           virtual_mailbox_maps = hash:/etc/postfix/vmailbox
           virtual_mailbox_base = /var/mail/vhost

           Anche la sintassi del le /etc/postfix/vmailbox è piuttosto inequivocabile: include due campi
           separati da una whitespace. Il primo campo è riservato all’indirizzo di posta elettronica del virtual
           domain ed il secondo campo è riservato al percorso in cui si trova la mailbox (condizionato dalla
           directory citata dal parametro virtual_mailbox_base). Se il nome della mailbox [incluso nel
           percorso de nito dal secondo campo] termina con una slash (/) la mailbox stessa verrà salvata in
           formato maildir; in caso contrario, verrà utilizzato il formato tradizionale mbox. Il formato maildir
           utilizza un’intera directory per la mailbox, conservando ogni singolo messaggio in un le dedicato.
           Diversamente, il formato mbox memorizza l’intera mailbox in un solo le, in cui ogni riga che inizia
           con “From” (seguito da uno spazio) indica l'inizio di un nuovo messaggio.

                                                         Esempio 11.5 Il le /etc/postfix/vmailbox

           # Jean’s email is stored as maildir, wit
           # one file per email in a dedicated director
           jean@falcot.org falcot.org/jean
           # Sophie’s email is stored in a traditional ”mbox” file
           # with all mails concatenated into one single fil
           sophie@falcot.org falcot.org/sophi


           11.1.3. Restrizioni per la ricezione e la trasmissione

           Con il crescente numero di Unsolicited Bulk Email - UBE (genericamente de nite spam - posta
           elettronica massiva indesiderata dai contenuti commerciali, offensivi o di poco valore) sono
           necessarie delle contromisure sempre più severe per valutare quali messaggi il server può ricevere.
           Questo paragrafo tratta alcune di queste strategie integrate in Post x.


                       CULTURA                 Il termine spam si riferisce genericamente a tutte le unsolicited commercial
               Il problema dello               emails (il cui acronimo è UCE) che invadono le caselle emails; mentre vengono
               spam                            de niti spammers le persone senza scrupoli che inviano lo spam. Agli spammers
                                               non importa quale fastidio arrecano, in quanto la campagna email-spam avrà per
                                               loro statisticamente più bene ci che costi anche se soltanto una piccolissima
                                               percentuale di destinatari si lascia tentare dalla promozione. Il meccanismo che gli
                                               spammers utilizzano è piuttosto automatizzato: in pratica qualsiasi email resa
                                               pubblica su internet (ad esempio, attraverso un forum web, una mailing list, un
                                               blog, ecc.) viene rilevata dagli spambots per poi essere oggetto di un usso continuo
                                               di messaggi indesiderati.
                                               Tutti gli amministratori IT cercano di far fronte allo spam attraverso la
                                               con gurazione di ltri, ma gli spammers studiano il modo di aggirarli. A volte gli
                                               spammers per i loro scopi acquistano servizi distribuiti attraverso reti di macchine
                                               compromesse da worm da parte di organizzazioni criminali che le controllano.
                                               Statistiche recenti stimano che il 95% della posta inviata è spam!




                               TDAH_1.0   Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 257
fi
     fi
          fi
                fi
                     fi
                          fi
                                   fi
                                               fi
                                                    /

                                                         e

                                                               

                                                                   s

                                                                        fi
                                                                             h

                                                                                  y

                                                                                        

                                                                                       e

                                                                                            fl
                                                                                                 fi
                                                                                                      ,

                                                                                                       fi
                                                                                                            fi
                                                                                                                 fi
          11.1.3.1 Come limitare l'accesso in base all'indirizzo IP

          La direttiva smtpd_client_restrictions controlla quali macchine sono autorizzate a comunicare
          con il server di posta.

                                          Esempio 11.6 Restrizioni basate sull'indirizzo del client

          smtpd_client_restrictions = permit_mynetworks
           warn_if_reject reject_unknown_client,
           check_client_access hash:/etc/postfix/access_clientip,
           reject_rbl_client sbl-xbl.spamhaus.org,
           reject_rbl_client list.dsbl.or

          Se una variabile contiene un elenco di regole come nell'esempio soprastante, tali regole vengono
          prese in consegna in base alla loro posizione nell’elenco, dalla prima all'ultima regola. In pratica ogni
          regola determina le sorti del messaggio: l’accettazione, il suo diniego o lasciare che continui ad
          essere valutato in base alla regola successiva. Pertanto la posizione di una regola nell’elenco ha
          molta importanza tanto che l’inversione della posizione di due regole può determinare degli effetti
          del tutto differenti.
          La direttiva permit_mynetworks, collocata in cima all'elenco delle regole, impone che vengano
          accettate incondizionatamente le emails provenienti da qualsiasi macchina sulla rete locale (come
          ribadito dalla con guration variable mynetworks).
          La seconda direttiva dovrebbe normalmente imporre di ri utare le emails provenienti da macchine
          senza una valida con gurazione DNS. Una con gurazione DNS può ritenersi valida se l’indirizzo IP
          può essere risolto in un nome e se è possibile anche la risoluzione inversa ovvero il nome può
          essere risolto in un indirizzo IP. Purtroppo questa regola potrebbe essere esageratamente stringente,
          dato che diversi mail servers non dispongono di un reverse DNS per il loro indirizzo IP. Pertanto gli
          amministratori della Falcot Corp hanno preferito anteporre alla direttiva
          disable_unknown_client il modi er warn_if_reject, che trasforma la regola di diniego in un
          semplice warning (avviso) nel registro dei logs. In questo modo gli amministratori IT possono
          monitorare il numero di messaggi potenzialmente oggetto di ri uto e valutare consapevolmente se
          attivare la restrizione.


           SUGGERIMENTO                  Tra i meccanismi per determinare le restrizioni vi sono anche le access tables
           Le access tables              (modi cabili dall’amministratore) che elencano le combinazioni di mittenti,
                                         indirizzi IP, hostnames (autorizzati o vietati). Le access tables possono essere
                                         create copiando una versione non compressa del le /usr/share/doc/postfix-
                                         doc/examples/access.gz. Questo modello è self-documented attraverso
                                         l’inclusione di commenti ovvero ciascuna tavola documenterà la propria sintassi.
                                         La tabella /etc/postfix/access_clientip elenca gli indirizzi IP e le reti; la
                                         tabella /etc/postfix/access_helo elenca i domain names; la tabella /etc/
                                         postfix/access_sender contiene l’elenco degli indirizzi emails. Dopo ogni
                                         modi ca, ciascuno di questi les deve essere convertito in una hash-table, ovvero in
                                         un formato ottimizzato per il fast access [trad. non lett. “lettura-esecuzione
                                         rapida”] attraverso il comando postmap /etc/postfix/file.



          La terza direttiva consente all'amministratore di con gurare attraverso il le /etc/postfix/
          access_clientip una blacklist ed una whitelist dei mail servers. La whitelist consente
          all'amministratore di speci care i servers attendibili e di conseguenza esentati dall’essere sottoposti
          al vaglio delle regole successive.




          Pagina 258 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
     fi
                fi
                     fi
                          fi
                               fi
                                    fi
                                            g

                                                  fi
                                                       fi
                                                             

                                                                  

                                                                      fi
                                                                           ,

                                                                                fi
                                                                                     fi
                                                                                           

                                                                                               fi
               Le ultime due regole dell'esempio soprastante puntano a due blacklists ed impongono il ri uto di
               qualsiasi messaggio proveniente da uno dei servers elencati nelle blacklists (RBL è l’acronimo
               Remote Black List, ovvero blacklist remota). Queste blacklists possono elencare servers mal
               con gurati che gli spammers usano per trasmettere la loro posta, così come note unexpected mail
               relays tra cui macchine infettate da worm o da altri viruses. [Genericamente un SMTP relay è un
               server, solitamente gestito da un ISP, che si occupa solo della trasmissione/inoltro delle email in
               uscita]

                SUGGERIMENTO                      Le blacklists a volte includono un server legittimo che è stato vittima di
                White list e RBLs                 problematiche. In teoria pertanto la posta proveniente da quel server dovrebbe
                                                  essere ri utata; la whitelist de nita nel le /etc/postfix/access_clientip vi
                                                  consentirà di ricevere comunque la posta dal quel server [a condizione che lo
                                                  includiate nel summenzionato elenco]
                                                  Per questo motivo dovrete agire con prudenza prima di inserire nella whitelist un
                                                  mail server, includendo soltanto i mail servers di cui vi date e con i quali scambiate
                                                  molta posta.




               11.1.3.2 Veri ca della legittimità attraverso il comando EHLO o HELO

               Ogni trasmissione SMTP exchange inizia con un comando HELO (o EHLO) seguito dal nome del mail
               server mittente; la veri ca della legittimità del nome annunciato del mail server mittente concede
               dei bene ci.

                                      Esempio 11.7 Restrizioni sul nome annunciato dal comando l'EHLO

               smtpd_helo_restrictions = permit_mynetworks
                reject_invalid_hostname
                check_helo_access hash:/etc/postfix/access_helo,
                reject_non_fqdn_hostname
                warn_if_reject reject_unknown_hostnam

               La prima direttiva allow_mynetworks consente a tutte le macchine sulla rete locale di annunciare il
               proprio nome senza restrizioni. La direttiva in questione ha la sua importanza, in quanto diversi
               softwares di posta elettronica non rispettano i requisiti minimi di questa parte del protocollo SMTP,
               annunciando nomi senza senso.
               La regola reject_invalid_hostname ri uta qualsiasi email con un annuncio EHLO che indica un
               hostname sintatticamente errato. La regola reject_non_fqdn_hostname ri uta qualsiasi email se
               l’hostname indicato nell’annuncio EHLO non è un fully-qualified domain name (che include un
               domain name oltre all’hostname). La regola reject_unknown_hostname ri uta qualsiasi email se il
               nome annunciato dal comando EHLO non esiste nel database DNS. Gli amministratori della Falcot
               Corp hanno preferito mitigare quest'ultima regola in quanto causerebbe il ri uto di troppe emails,
               attraverso il modi er warn_if_reject; così facendo potranno valutare gli effetti della direttiva e
               decidere se attivarla o meno.
               La direttiva allow_mynetworks essendo posta come prima regola nell’ordine dell’elenco determina
               un effetto che si ri ette anche sulle regole successive: ovvero le direttive seguenti potranno essere
               applicate esclusivamente nei confronti delle emails provenienti da macchine non appartenenti alla
               rete locale. Così facendo potrete inserire nella blacklist tutti gli hosts che [pur non facendo parte
               della rete locale] si annunciano come membri [del dominio] falcot.com, per esempio aggiungendo la
               riga falcot.com REJECT You are not in our network! al le /etc/postfix/access_helo.




                           TDAH_1.0         Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 259
fi
     fi
          fi
                fi
                     fi
                      fl
                            fi
                                 fi
                                       ,

                                            ,

                                                 fi
                                                      fi
                                                           fi
                                                                e

                                                                     fi
                                                                          ,

                                                                               fi
                                                                                     

                                                                                                fi
                                                                                                 fi
                                                                                                      fi
                                                                                                                 fi
     11.1.3.3 Consenso o diniego in base al Mittente Annunciato

     Ogni messaggio ha un un mittente annunciato dal comando MAIL FROM del protocollo SMTP; anche
     questa informazione può essere sottoposta a diversi controlli.

                                           Esempio 11.8 Restrizioni sul mittente

     smtpd_sender_restrictions
        check_sender_access hash:/etc/postfix/access_sender
        reject_unknown_sender_domain, reject_unlisted_sender,
        reject_non_fqdn_sende

     La tabella /etc/postfix/access_sender de nisce se accettare o meno determinati utenti. In
     genere dovrete solo inserire gli utenti in una white list o black list.
     La regola reject_unknown_sender_domain richiede un dominio mittente valido, necessario per un
     indirizzo valido. La regola reject_unlisted_sender ri uta i mittenti locali se il loro indirizzo non
     esiste. Ciò esclude quelle emails che sono state inviate da un indirizzo non valido con dominio
     falcot.com: ad esempio qualsiasi messaggio proveniente dal mittente joe.bloggs@falcot.com verrà
     accettato solo se questo indirizzo esiste davvero.
     In ne, la regola reject_non_fqdn_sender impone il ri uto delle email provenienti da indirizzi e-
     mail privi di un full quali ed domain name. In concreto, verranno ri utate le emails provenienti da
     indirizzi con sintassi del tipo user@machine: l’indirizzo deve essere annunciato con una sintassi
     tipo user@machine.example.com oppure user@example.com .


     11.1.3.4 Consenso o diniego in base al Destinatario

     Ogni email ha anche un destinatario, annunciato tramite il comando RCPT TO del protocollo SMTP.
     Inoltre questi indirizzi come i precedenti possono essere altrettanto veri cati, ma la veri ca in sé
     comporta dei bene ci minori rispetto alla veri ca dell’indirizzo del mittente.

                                         Esempio 11.9 Restrizioni sul destinatario

     smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination, reject_unlisted_recipient,
        reject_non_fqdn_recipien

     reject_unauth_destination è una regola piuttosto basilare, in pratica l’emails provenienti da
     macchine al di fuori della rete devono essere indirizzate verso il mail server correttamente; se
     l’emails in questione sono destinate ad indirizzi inesistenti dovranno essere ri utate. Senza questa
     regola, il mail server diverrebbe open relay consentendo agli spammers di inoltrare emails non
     desiderate; è preferibile pertanto porre tale regola in prossimità dell'inizio della lista in modo che
     nessun'altra regola rischi di autorizzare il ricevimento dell’emails prima del controllo del
     destinatario.




     Pagina 260 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
            fi
                   fi
                         r

                              =

                                   t

                                           fi
                                            fi
                                                      fi
                                                           fi
                                                                 

                                                                     fi
                                                                          ,

                                                                                

                                                                                

                                                                                    fi
                                                                                         fi
                                                                                              fi
               La regola reject_unlisted_recipient dispone il ri uto dei messaggi inviati ad utenti locali
               inesistenti (il che ha senso!). In ne, la regola reject_non_fqdn_recipient impone il ri uto degli
               indirizzi non fully-quali ed; quindi verrano ri utate l’emails inviate al mail server con indirizzi di
               destinazione con sintassi jean o jean@machine; diversamente la sintassi full-quali ed idonea per gli
               indirizzi è jean@machine.falcot.com o jean@falcot.com.


               11.1.3.5 Restrizioni relative al comando DATA

               Il comando DATA del protocollo SMTP precede l'invio contenuti del messaggio. Non fornisce alcuna
               informazione di per sé, ma si limita ad annunciare ciò che gli seguirà. Può essere oggetto di controlli.

                                                                        Esempio 11.10 Restrizione sul comando DATA

               smtpd_data_restrictions = reject_unauth_pipelinin

               La regola reject_unauth_pipelining causa il ri uto del messaggio se il mittente [durante lo
               scambio SMTP] invia un comando senza aver atteso la risposta al comando precedente. Questa
               precauzione è rivolta contro una comune funzionalità degli spambot utilizzata da quest’ultimi per
               incrementare l’ef cienza in termini di invio di mole di emails nel minor tempo possibile.


               11.1.3.6 Messa in atto delle restrizioni

               Sebbene tutti i comandi veri cano le informazioni fase per fase durante lo scambio SMTP, il ri uto
               effettivo viene messo in atto da Post x come risposta al comando RCPT TO.
               Ciò signi ca che nonostante il ri uto di un messaggio dovuto ad un comando EHLO non valido,
               Post x sarà comunque in grado di identi care il mittente ed il destinatario. Inoltre, non avendo
               interrotto lo scambio dall’inizio, Post x sarà in condizione di registrare un log sul messaggio con
               maggiori informazioni. Senza contare che diversi clients SMTP non si aspetterebbero di riscontrare il
               fallimento dello scambio SMTP a partire dai suoi primi comandi, subendo diversamente per mezzo di
               un ri uto tardivo minori grattacapi.
               Difatti il vantaggio di questo metodo è che le regole possono accumulare maggiori informazioni
               durante le diverse fasi dello scambio SMTP; questo metodo consente per di più un controllo dei
               permessi fine-grained [termine che può essere tradotto letteralmente come “a grana ne”, ma che
               si riferisce all’omonima tecnica di controllo accessi capillare implementata per la gestione di grandi
               moli di dati] idonea per diverse controffensive come ad esempio il ri uto dei messaggi provenienti da
               mittenti che si annunciano illegittimamente come mittenti che appartengono alla stessa rete locale.


               11.1.3.7 Filtraggio basato sul contenuto del messaggio

               Il sistema di veri ca e restrizione non sarebbe completo senza una tecnica di controllo del contenuto
               del messaggio in sé. Post x distingue due tipi di controlli basati rispettivamente sull’email headers e
               sull’email body.




                              TDAH_1.0        Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 261
fi
     fi
          fi
                    fi
                         fi
                               fi
                                    fi
                                         fi
                                              fi
                                               fi
                                                    fi
                                                         fi
                                                              fi
                                                                   fi
                                                                           fi
                                                                                fi
                                                                                     fi
                                                                                            g

                                                                                                  fi
                                                                                                                 fi
                                                                                                                      fi
                                                                                                                           fi
                                                                                                                                fi
                                                              Esempio 11.11 Attivazione dei ltri sui contenuti

                header_checks = regexp:/etc/postfix/header_checks
                body_checks = regexp:/etc/postfix/body_check

                Entrambi i les contengono un elenco di regular expression (in ital. espressioni regolari
                comunemente denominate regexps o regexes) che se riscontrate nelle intestazioni o nel corpo
                dell’email attivano un'azione da eseguire.

                             BREVE                  Il le /usr/share/doc/postfix-doc/examples/header_checks.gz presenta
                          ACCENNO                   diversi commenti esplicativi allo scopo di essere utilizzato come punto di partenza
                    Regexp tables                   per creare i les /etc/postfix/header_checks e /etc/postfix/body_checks.



                                                    Esempio 11.12 Esempio del le /etc/post x/header_checks

                /^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
                /^Subject: *Your email contains VIRUSES/ DISCARD virus notificatio


                           BASILARE                 Il termine regular expression (in ital. espressione regolare comunemente
                    Espressione                     denominate regexps o regexes) si riferisce ad una notazione generica utilizzata
                    regolare                        per esprimere la descrizione dei contenuti e/o della struttura di una stringa di
                                                    caratteri. Alcuni caratteri speciali consentono di poter: de nire delle alternative
                                                    (ad esempio, "foo|bar" ovvero o "foo" o "bar"); con gurare i caratteri ammessi
                                                    (ad esempio "[0-9]" si riferisce ai numeri compresi tra 0 e 9, mentre con un punto
                                                    "." si intende qualsiasi carattere); eseguire quanti cazioni attraverso un
                                                    quantifier [molto genericamente un quantifier è un operatore logico che
                                                    consente di speci care la quantità delle singole unità] (ad esempio ad "s?" può
                                                    essere associata una stringa vuota oppure una singola unità del carattere "s", in
                                                    altre parole 0 unità del carattere “s” oppure 1 unità del carattere "s"; diversamente
                                                    ad "s +" può essere associata una singola unità del carattere “s” oppure diverse
                                                    unità del carattere “s” consecutive, ecc.). Le parentesi vengono utilizzate per
                                                    aggregare i risultati di ricerca.
                                                    La sintassi delle regular expression può variare in base al tool che se ne serve, ma le
                                                    funzionalità basilari rimangono le stesse.

                                                         http://en.wikipedia.org/wiki/Regular_expression


                Nell’esempio 11.12, riguardante le veri che delle intestazioni delle emails, la prima riga impone il
                controllo dell’annuncio che de nisce il software email del mittente: se riscontra GOTO Sarbacane (un
                software per l'invio massivo di email), il messaggio verrà ri utato. La seconda riga veri ca il
                subject (oggetto) del messaggio: se ricorda quanto trattato da una noti ca virus, il messaggio pur
                non essendo ri utato viene eliminato immediatamente.

                L'uso di questi ltri è un'arma a doppio taglio, perché facilmente possono essere resi troppo generici
                e di conseguenza l’emails legittime possono andare perdute. In questi casi, non solo i messaggi
                andranno persi, ma anche i loro mittenti saranno infastiditi da messaggi di errore indesiderati.


                11.1.4. Con gurazione: greylisting

                Il greylisting è una tecnica di ltraggio che prevede il ri uto iniziale sistematico dei messaggi
                attraverso un temporary error code e la loro l'accettazione solo al loro secondo tentativo dopo un
                determinato periodo di tempo.




                Pagina 262 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
     fi
          fi
               fi
                     fi
                      fi
                           fi
                                fi
                                     fi
                                          fi
                                               fi
                                                    fi
                                                         fi
                                                                  fi
                                                                       fi
                                                                            fi
                                                                                 fi
                                                                                 s

                                                                                      fi
                                                                                            

                                                                                                fi
                                                                                                          

                                                                                                              n

                                                                                                                   fi
                              Questo ltro è particolarmente ef cace contro lo spam inviato da macchine infettate da worms e
                              virus dato che raramente questi softwares funzionano come un full SMTP (difatti diversamente
                              quest’ultimo veri ca gli error codes e ritenta in un secondo momento l’invio dei messaggi con una
                              prima trasmissione non andata a buon ne), né gli spammers hanno interesse che funzionino come
                              un full SMTP in quanto diversi harvested addresses [indirizzi emails rilasciati pubblicamente e
                              non, prelevati con diverse tecniche ed utilizzati prevalentemente per scopi illeciti] potrebbero ormai
                              essere inutilizzati ed il reinvio dei messaggi comporterebbe di conseguenza un’ulteriore perdita di
                              tempo.
                              Post x non integra questa funzionalità nativamente, ma include comunque una funzione che
                              consente di delegare ad un programma terzo la decisione (consenso o ri uto) sull’esito di un dato
                              messaggio ricevuto. Il pacchetto postgrey offre un programma designato per interfacciarsi con il
                              suddetto access policy delegation service.
                              Dopo essere stato installato e messo in esecuzione postgrey si comporta come un daemon in
                              ricezione del port 10023. Per con gurare post x ad utilizzare postgrey dovrete immettere come
                              restrizione aggiuntiva il parametro check_policy_service:

                              smtpd_recipient_restrictions = permit_mynetworks,
                                  [...
                                  check_policy_service inet:127.0.0.1:1002

                              Ogni volta che Post x controlla il ruleset e di conseguenza raggiunge la summenzionata restrizione,
                              si connette al daemon postgrey per trasmettergli le informazioni sul messaggio in questione.
                              Dopodiché Postgrey veri ca il [set di tre fattori/dati denominato] triplet (indirizzo IP, mittente e
                              destinatario) del messaggio in questione e veri ca nel suo database se già ha avuto modo di
                              incontrarlo. Se riconosce il triplet postgrey restituisce l’ordine di accettare il messaggio,
                              diversamente, qualora non lo riconoscesse, ordina di ri utare temporaneamente il messaggio e ne
                              memorizza il triplet nel proprio database.
                              L’inconveniente principale dell’uso del greylisting è il ritardo, talvolta inaccettabile, della ricezione
                              dell’e-mails legittime. Difatti incrementa il burden dei servers [genericamente il burden rate è il
                              tasso di carico ottenuto dalla comparazione dei costi indiretti (dividendo) per i costi diretti
                              (divisore)] che inviano diverse emails legittime.

                                    IN PRATICA                 In teoria il greylisting ritarda solo la prima email di un dato mittente destinata
                               Limitazioni del                 ad un dato destinatario ed il ritardo standard dovrebbe essere una questione di
                               greylisting                     minuti. Tuttavia, la realtà potrebbe discostarsi dalla teoria. Difatti diversi ISPs di
                                                               grandi dimensioni utilizzano clusters di SMTP servers; ciò comporta che al primo
                                                               ri uto del messaggio, potrebbe rispondere, con un secondo tentativo di invio, un
                                                               altro server rispetto a quello che ha di fatto inviato il messaggio. Come conseguenza
                                                               a ciò anche il secondo server riceve un ri uto per le restrizioni imposte dal
                                                               greylisting [così come lo riceveranno pure gli altri servers del cluster che verranno
                                                               coinvolti]; il delay (ritardo) imposto per il rinvio tenderà ad incrementarsi in
                                                               quanto il server SMTP, ad ogni trasmissione fallita, aumenta sistematicamente il
                                                               tempo di attesa per poter effettuare nuovamente la trasmissione del messaggio e da
                                                               una manciata di minuti passeranno diverse ore prima che il ri uto possa essere
                                                               trasmesso ad un server del cluster già coinvolto.
                                                               È intuibile che l'indirizzo IP del server mittente di un dato mittente potrebbe non
                                                               essere necessariamente sempre lo stesso. Senza contare che persino l'indirizzo
                                                               email di un dato mittente potrebbe differire. Per fare un esempio diversi mailing list
                                                               servers codi cano le informazioni extra dell'indirizzo del mittente per gestire
                                                               automaticamente gli error messages denominati bounces [in ital. lett. “respinti” -
                                                               quando un’email viene respinta il server destinatario invia al server mittente una
                                                               delivery status notification (DSN) denominata bounce message]. Inoltre i
                                                               messaggi in entrata del mailing-list server potrebbero dover superare anche un
                                                                 ltro greylisting, il che implica che il server mittente conservi (temporaneamente)
                                                               il messaggio inviato. Per i mailing-list servers con decine di migliaia di utenti
                                                               inscritti, ciò può diventare rapidamente problematico.
                                                               Per ovviare a tali inconvenienti, Postgrey dispone di una whitelist per questo tipo di
                                                               di siti in modo da imporre il consenso immediato dei loro messaggi, senza necessità
                                                               della convalida della restrizione greylisting. Potrete personalizzare la whitelist [dei
                                                               mailing-list servers] in base alle vostre esigenze modi cando il le /etc/
                                                               postgrey/whitelist_clients.




                                             TDAH_1.0   Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 263
fi
     fi
          fi
               fi
                    ]

                         fi
                                   fi
                                        fi
                                                fi
                                                          fi
                                                          fi
                                                               fi
                                                                    fi
                                                                         fi
                                                                              fi
                                                                                   fi
                                                                                        fi
                                                                                             fi
                                                                                                  3

                                                                                                       fi
                                                                                                            fi
                                                                                                                  

                                                                                                                      fi
                      ANDANDO                      Per limitare gli svantaggi delle restrizioni greylisting è consigliabile applicarle solo
                           OLTRE                   ad un subset di clients, già noti come potenziali fonti di spam in quanto elencati in
               Selective                           una blacklist DNS. Ciò non è possibile con postgrey e dovrete fare riferimento a
               greylisting                         questo scopo al pacchetto milter-greylist.
               attraverso                          In questo scenario le DNS blacklists non sono suf cienti per determinare il diniego
                                                   in tutti i casi opportuni, pertanto è consigliabile fare uso di blacklists più
               milter-greylist                     aggressive, che includano tutti gli indirizzi IP dinamici degli ISP clients, tra cui
                                                   pbl.spamhaus.org o dul.dnsbl.sorbs.net.
                                                   La con gurazione di milter-greylist in Post x si limita a smtpd_milters =
                                                   unix:/var/run/milter-greylist/milter-greylist.sock, dal momento che
                                                   milter-greylist utilizza la milter interface prede nita per Sendmail. La manual
                                                   page greylist.conf(5) documenta il le /etc/milter-greylist/
                                                   greylist.conf ed i vari criteri per con gurare milter-greylist. Dovrete
                                                   comunque modi care il le /etc/default/milter-greylist per attivare il
                                                   servizio.




           11.1.5. Personalizzazione dei ltri in base al destinatario

           Il paragrafo 11.1.3, "Restrizioni per la Ricezione e la Trasmissione" a pagina 257 ed il paragrafo
           11.1.4, "Con gurazione: greylisting" a pagina 262 hanno trattato diversi tipi di restrizioni. Per
           quanto tali restrizioni limitino la quantità di spam ricevuto, presentano tutte piccoli inconvenienti.
           Quest’ultimi sono comunemente contrastati attraverso il ltraggio basato su destinatari. Alla Falcot
           Corp, il greylisting è stato apprezzato dalla maggior parte degli utenti ad eccezione di coloro i
           quali svolgono mansioni che richiedono bassa latenza per l’emails (ad esempio i servizi di supporto
           tecnico). Nel frattempo il reparto vendite ha dei grattacapi nel ricevere le emails da alcuni fornitori
           dell’Asia perché quest’ultimi potrebbero essere stati inclusi in delle blacklists; di conseguenza tale
           reparto ha fatto esplicita richiesta di emails non ltrate, idonee per la ricezione della
           corrispondenza.
           Post x gestisce il ltraggio attraverso un "restriction class" concept. Le classi vengono dichiarate nel
           parametro smtpd_restriction_classes e de nite con lo stesso metodo del parametro
           smtpd_recipient_restrictions. La direttiva check_recipient_access de nisce invece la table
           mapping che associa determinate restrizioni nei confronti di determinati destinatari.

                                         Esempio 11.13 Come vengono de nite le restriction classes in main.cf

           smtpd_restriction_classes = greylisting, aggressive, permissiv

           greylisting = check_policy_service inet:127.0.0.1:10023
           aggressive = reject_rbl_client sbl-xbl.spamhaus.org
                  check_policy_service inet:127.0.0.1:1002
           permissive = permi

           smtpd_recipient_restrictions = permit_mynetworks,
                  reject_unauth_destination
                  check_recipient_access hash:/etc/postfix/recipient_access




           Pagina 264 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
     fi
          fi
                fi
                     fi
                          fi
                               t

                                    fi
                                         fi
                                              fi
                                                   fi
                                                        ,

                                                             fi
                                                                  fi
                                                                       fi
                                                                            fi
                                                                                 fi
                                                                                      fi
                                                                                           3

                                                                                                 

                                                                                                     ,

                                                                                                           

                                                                                                               e

                                                                                                                    fi
                                       Esempio 11.14 Il le /etc/post x/recipient_access

     # Unfiltered addresse
     postmaster@falcot.com                  permissiv
     support@falcot.com                     permissiv
     sales-asia@falcot.com                  permissiv

     # Aggressive filtering for some privileged user
     joe@falcot.com         aggressiv

     # Special rule for the mailing-list manage
     sympa@falcot.com       reject_unverified_sende

     # Greylisting by defaul
     falcot.com              greylistin


     11.1.6. Integrazione di un antivirus

     A causa dei diversi virus che vengono diffusi attraverso gli allegati emails, è importante con gurare
     un antivirus nell’entry point della rete aziendale, in quanto nonostante le campagne di
     sensibilizzazione sull’argomento, ci sarà sempre qualche utente che aprirà l’allegato di un messaggio
     sospetto.
     L'antivirus gratuito scelto dagli amministratori della Falcot è clamav. Pertanto gli amministratori
     hanno installato il main package clamav ed altri pacchetti come arj, unzoo, unrar e lha, che
     mettono in condizioni l'antivirus di scansionare gli allegati compressi in uno di questi formati.
     L’attività di interfacing fra l’antivirus ed l’email server è af data a clamav-milter. Un programma
     milter (termine derivato dall'espressione inglese mail filter, ltro della posta elettronica) è un
     software di ltraggio della posta progettato appositamente per interfacciarsi con gli email servers. I
     programmi di tipo milter utilizzano un'application programming interface (API) che gestisce
     le esecuzioni meglio rispetto ai ltri esterni agli emails server. Sendmail ha introdotto per primo i
     milters e Postfix ne ha seguito l'esempio.

                BREVE             Il pacchetto spamass-milter contiene un milter basato sul popolare software di
             ACCENNO              rilevamento dell’emails indesiderate Spamassassin. Può essere utilizzato per
      Un milter per               contrassegnare i potenziali messaggi spam (aggiungendo un extra header) e/o per
      Spamassassin                disporne il ri uto qualora il punteggio “spamminess” del messaggio superi una
                                  soglia stabilita.


     Una volta installato il pacchetto clamav-milter, il milter dovrebbe essere ricon gurato in modo che
     si metta in esecuzione attraverso un TCP port piuttosto che attraverso il prede nito named socket
     [un file descriptor per le interprocess comunication (IPC), le trasmissioni dati fra processi].
     Potrete farlo eseguendo dpkg-reconfigure clamav-milter. Vi verrà richiesto di con gurare la
     “Communication interface with Sendmail” e dovrete rispondere “inet:10002@127.0.0.1”.




              TDAH_1.0       Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 265
fi
 fi
        fi
                   s

                   fi
                        t

                             fi
                                  fi
                                       e

                                       e

                                       e

                                       e

                                            g

                                                        r

                                                             r

                                                                  fi
                                                                   s

                                                                        fi
                                                                                     fi
                                                                                          fi
                                                                                               fi
                                                                                                     fi
                                   NOTA                    La ragione per cui viene usato un port TCP piuttosto che un named socket è che il
                TCP port vs                                demone Post x viene eseguito chrooted [ovvero in una directory tree designata
                                                           dalla quale non può raggiungere i les all’esterno] e non ha modo di accedere alla
                named socket?                              directory in cui si trova il named socket. Tuttavia potrete continuare ad utilizzare
                                                           un named socket modi cando la sua posizione all’interno di chroot (ovvero in /
                                                           var/spool/postfix/).



               La con gurazione standard di ClamAV va bene nella maggior parte dei casi, anche se dpkg-recon
               clamav-base consente di personalizzare i parametri più importanti.
               Come ultimo passaggio dovrete comunicare a Post x di utilizzare il ltro con gurato. Per fare ciò
               aggiungete la seguente direttiva in /etc/postfix/main.cf:

               # Virus check with clamav-milte
               smtpd_milters = inet:[127.0.0.1]:1000

               Qualora dovessero insorgere problemi con l’antivirus, dovrete semplicemente commentare [#] la
               riga ed eseguire il comando service postfix reload in modo che la modi ca diventi ef cace.

                      IN PRATICA                           Una volta installato l'antivirus, è necessario veri care che funzioni correttamente.
                Testate                                    Il modo più semplice per farlo è inviare un'e-mail di prova con allegato il le
                                                           eicar.com o eicar.com.zip , che può essere recuperato online:
                l'antivirus
                                                             http://www.eicar.org/86-0-Intended-use.html

                                                           Non si tratta di un vero virus, ma di un test le identi cato da tutti gli antivirus
                                                           presenti sul mercato come minaccia in modo che si possa veri care l'installazione.

               Giunti a questo punto nalmente i messaggi elaborati da Post x vengono ltrati dall’antivirus.


               11.1.7. Authenticated SMTP

               Per poter inviare delle e-mails occorre la disponibilità di una connessione ad un SMTP server e che
               quest’ultimo autorizzi l’invio delle emails suo tramite. I problemi possono sorgere con i roaming
               users, dato che ciò richiederebbe la modi ca regolare della con gurazione dei SMTP client; difatti
               l’SMTP server della Falcot ri uta l'inoltro dei messaggi provenienti da un indirizzo IP
               apparentemente non della società. Esistono due soluzioni: la prima soluzione è che i roaming users
               installino un SMTP server sul proprio computer; la seconda soluzione è che i roaming users
               continuino ad utilizzare l’SMTP server della società a patto che effettuino l’autenticazione come
               dipendenti. La prima soluzione è sconsigliata perché il computer non è connesso in modo
               permanente e quindi non può tentare di ritrasmettere i messaggi in caso di problemi; pertanto è
               meglio soffermarsi sulla seconda soluzione.
               L'autenticazione SMTP di Post x si basa su SASL (Simple Authentication and Security Layer).
               Dovrete installare i pacchetti libsasl2-modules e sasl2-bin; dopodiché dovrete registrare una
               password per ciascun utente nel database SASL in modo che ciascun utente sia in grado di
               autenticarsi sull’SMTP server. Dovrete usare pertanto il comando saslpasswd2. L'opzione -u
               de nisce l’authentication domain, che deve corrispondere al parametro Post x
               smtpd_sasl_local_domain. L'opzione -c viene utilizzata per creare un utente, mentre l'opzione -f
               viene utilizzata per speci care il le da utilizzare qualora il database SASL sia stato archiviato
               altrove rispetto alla sua posizione standard (/etc/sasldb2).




               Pagina 266 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
     fi
          fi
                        fi
                             fi
                                  fi
                                       fi
                                            fi
                                                 fi
                                                      fi
                                                              r

                                                                   fi
                                                                        fi
                                                                             fi
                                                                                  2

                                                                                       fi
                                                                                            fi
                                                                                                 fi
                                                                                                      fi
                                                                                                           fi
                                                                                                                fi
                                                                                                                     fi
                                                                                                                          fi
                                                                                                                               fi
                                                                                                                                    fi
                                                                                                                                     fi
                                                                                                                                          fi
               # saslpasswd2 -h ‘postconf -h myhostname‘ -f /var/spool/postfix/etc/sasldb2 -c jean
               [... type jean’s password twice ...

               Si precisa che il database SASL è stato creato nella directory Post x. Per garantire coerenza, occorre
               convertire /etc/sasldb2 in un symbolic link che punta al database utilizzato da Post x attraverso
               il comando ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2.
               Giunti a questo punto resta da con gurare Post x per utilizzare SASL. Innanzitutto, dovrete
               aggiungere il post x user al sasl group in modo che possa accedere al SASL account database.
               Successivamente dovrete abilitare SASL e con gurare il parametro
               smtpd_recipient_restrictions in modo che quest’ultimo non impedisca ai SASL-autheticated
               clients di inviare e-mails liberamente.

                                                Esempio 11.15 Come abilitare SASL in /etc/postfix/main.cf

               # Enable SASL authenticatio
               smtpd_sasl_auth_enable = ye
               # Define the SASL authentication domain to use
               smtpd_sasl_local_domain = $myhostnam
               [...
               # Adding permit_sasl_authenticated before reject_unauth_destination
               # allows relaying mail sent by SASL-authenticated users
               smtpd_recipient_restrictions = permit_mynetworks
                    permit_sasl_authenticated
                    reject_unauth_destination
               [...

                         EXTRA                                 La maggior parte degli email clients (softwares di posta elettronica) attuali è in
                Authenticated                                  grado di autenticarsi con un server SMTP per inviare gli outgoing messages (la
                                                               posta in uscita) e tale funzionalità viene attivata semplicemente attraverso la mera
                SMTP client
                                                               con gurazione dei parametri appropriati. Qualora l’email client che utilizzate non
                                                               fosse provvisto di tale funzionalità potrete mettere in atto un workaround
                                                               attraverso il server Post x locale, con gurandolo in modo che inoltri le emails al
                                                               server SMTP remoto. In questo caso, sarà Post x stesso il client che si autentica
                                                               attraverso SASL. Ecco i parametri necessari:
                                                               smtp_sasl_auth_enable = ye
                                                               smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
                                                               relay_host = [mail.falcot.com
                                                               Il le /etc/postfix/sasl_passwd deve includere l’username e la password da
                                                               utilizzare per l’autenticazione sul server mail.falcot.com. Ecco un esempio:
                                                               [mail.falcot.com]          joe:LyinIsj
                                                               Come con tutte le Post x maps, dovrete convertire il suddetto le in /etc/
                                                               postfix/sasl_passwd.db attraverso il comando postmap.




                              TDAH_1.0    Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 267
fi
     fi
          ]

          ]

                    fi
                         fi
                              fi
                                     s

                                           ]

                                                s

                                                n

                                                fi
                                                     fi
                                                          i

                                                               fi
                                                                    ,

                                                                    ,

                                                                         ]

                                                                              fi
                                                                                   e

                                                                                        fi
                                                                                             fi
                                                                                                  fi
                                                                                                        

                                                                                                            ,

                                                                                                                  

                                                                                                                      fi
                                                                                                                            

                                                                                                                                fi
                                                                                                                                      

11.2. Server Web (HTTP)

Gli amministratori della Falcot Corp hanno scelto Apache come loro HTTP server di cui Debian
Jessie distribuisce la versione 2.4.10.


    ALTERNATIVA            Apache è uno dei web servers più conosciuti e utilizzati, ma esistono delle
 Altri server web          alternative; gli altri web servers hanno prestazioni migliori di Apache per alcuni
                           workloads, ma offrono minori funzionalità e moduli. Pertanto se avete necessità di
                           un web server per static files [ad esempio HTML, CSS, immagini, JavaScript] o
                           per svolgere le attività di un proxy server, fareste bene a prendere in
                           considerazione delle alternative, come ad esempio nginx e lighttpd.


11.2.1. Installazione di Apache

Dovrete installare soltanto il pacchetto apache2. Difatti questo pacchetto contiene già tutti i moduli
necessari, inclusi i Multi-Processing Modules (MPM) determinanti per Apache af nché possa
gestire il parallel processing delle diverse istanze (moduli precedentemente distribuiti attraverso
diversi pacchetti apache2-mpm-*). Mentre il pacchetto apache2-utils, che vi consigliamo di
installare, contiene le utilities da riga di comando descritte più avanti.
Il modulo MPM di fatto utilizzato determina signi cativamente il metodo con cui Apache gestisce le
istanze simultanee. Difatti il worker MPM utilizza i threads (lightweight processes), mentre il
prefork MPM utilizza un pool of processes (collezione di processi) realizzato anticipatamente.
[Non ho tradotto letteralmente lightweight processes perché si tratta di un metodo per dividere i
processi in sotto processi di in me dimensioni. Vengono de niti thread pool i gestori dei threads.
Per maggiore chiarezza, genericamente, il worker MPM usa più child processes che gestiscono
diversi threads (i quali singolarmente si occupano di una connessione alla volta), mentre il prefork
MPM utilizza, con maggiore dispendio di memoria, più child processes che gestiscono singolarmente
un unico thread (il quale singolarmente si occupa di una connessione alla volta).] Anche l'event MPM
utilizza i threads, ma le connessioni inattive (in particolare quelle tenute aperte dalla funzionalità
HTTP keep-alive [HTTP persistent connection o HTTP connection reuse del protocollo HTTP])
vengono restituite ai threads dedicati alla loro gestione.
Gli amministratori della Falcot Corp installano inoltre libapache2-mod-php5 per includere il
supporto PHP in Apache. Questa scelta comporta la disattivazione dell'event MPM (prede nito) e
l’attivazione del prefork MPM, in quanto dei due solo il prefork MPM è compatibile con PHP.



       SICUREZZA           Per impostazione prede nita, Apache gestisce le istanze in entrata sotto l’identità
 Esecuzione sotto          dell’user www-data. In questo modo, una vulnerabilità di sicurezza in uno CGI
 l'utente www-             script eseguito da Apache (per una dynamic page) non può compromettere
                           l'intero sistema, ma solo i les la cui titolarità dei diritti spetta a questo utente. [CGI
 data
                           è l’acronimo di Common Gateway Interface ed è un’interfaccia che consente agli
                           users di un web server di eseguire un programma terzo o uno script denominato
                           CGI script]
                           Il modulo suexec consente il bypassing di questa regola in modo che gli CGI scripts
                           vengano eseguiti sotto l’identità di un altro utente. Occorre però con gurare Apache
                           per mezzo della direttiva SuexecUserGroup usergroup.
                           È anche possibile utilizzare un MPM dedicato, come quello distribuito attraverso
                           libapache2-mpm-itk. Il suo funzionamento è leggermente diverso, in quanto
                           consente “l’isolamento” dei virtual hosts (di fatto dei “sets of pages” ovvero degli
                           insiemi di pagine) in modo che svolgano le loro funzioni sotto l’identità di un
                           rispettivo utente, diverso fra loro. Pertanto, una vulnerabilità in un sito Web non
                           comprometterà i les appartenenti all'owner di un altro sito Web.




           BREVE           L'elenco completo dei moduli standard Apache standard può essere reperito online.
        ACCENNO
 Elenco dei moduli           http://httpd.apache.org/docs/2.4/mod/index.html




Pagina 268 Il Manuale dell’Amministratore di Debian TDAH_1.0
    fi
          fi
               fi
                    fi
                                         fi
                                                      fi
                                                           fi
                                                                                  fi
                                                                                         fi
               Apache è un server modulare e la maggior parte delle sue funzionalità viene implementata
               attraverso moduli esterni che il programma carica durante la sua inizializzazione. La con gurazione
               di default attiva solo i moduli maggiormente utilizzati e per abilitarne altri dovrete eseguire
               a2enmod module; diversamente il comando a2dismod module li disabiliterà. Questi due programmi
               non fanno altro che creare o rimuovere i collegamenti simbolici in /etc/apache2/mods-enabled/
               che puntano ai les reali (situati in /etc/apache2/mods-available/).
               Per impostazione prede nita, il web server è in ricezione sul port 80 (come con gurato in /etc/
               apache2/ports.conf) e carica le pagine dalla directory /var/www/html/ (come con gurato in /
               etc/apache2/sites-enabled/000-default.conf).


                               ANDANDO                        Apache 2.4 include il modulo SSL necessario per il secure HTTP (HTTPS). Per
                                   OLTRE                      attivarlo dovrete: eseguire a2enmod ssl; aggiungere le direttive necessarie nei
                         Supporto SSL                         con guration les. Troverete una con gurazione esempli cativa in /etc/apache2/
                                                              sites-available/default-ssl.conf.

                                                                       http://httpd.apache.org/docs/2.4/mod/mod_ssl.htm

                                                              Dovrete prendere altre precauzioni qualora desideriate integrare le connessioni
                                                              SSL con il Perfect Forward Secrecy (queste connessioni utilizzano delle
                                                              ephemeral session keys diverse per ogni sessione in modo che un’eventuale
                                                              compromissione di una delle chiavi segrete utilizzate dal server non possa
                                                              determinare la compromissione del traf co criptato raccolto dalla rete a seguito di
                                                              uno “snif ng” (intercettazione). Al riguardo date un’occhiata alle raccomandazioni
                                                              di Mozilla:

                                                                       https://wiki.mozilla.org/Security/Server_Side_TLS#Apache




               11.2.2. Con gurazione dei Virtual Hosts

               Un virtual host è un'identità (aggiuntiva) assunta dal web server.

               Apache distingue due tipi di host virtuali: quelli basati sull'indirizzo IP (o sul port) e quelli basati sul
               domain name del web server. Il primo metodo impone che venga assegnato un indirizzo IP diverso (o
               port) per ciascun sito mentre il secondo metodo utilizza un solo indirizzo IP (e port) ed siti
               differiscono fra loro in base all’hostname comunicato dal client HTTP (quest’ultimo metodo è
               compatibile solo con la versione 1.1 del protocollo HTTP, che fortunatamente esiste da abbastanza
               tempo dall’essere utilizzato da tutti i web browsers).

               La (pressante) scarsità di indirizzi IPv4 favorisce il secondo metodo. Tuttavia, se occorre rendere
               compatibili i virtual hosts con l’HTTPS la faccenda si complica, dato che il protocollo SSL non ha
               sempre supportato il name-based virtual hosting; inoltre l'estensione SNI (Server Name
               Indication) che rende possibile la sopracitata combinazione non è compatibile con tutti i browsers.
               Pertanto se occorre far eseguire più siti HTTPS dallo stesso server, è preferibile differenziarli,
               eseguendoli su ports differenti oppure su indirizzi IP differenti (possibilmente utilizzando l’IPv6).

               La con gurazione prede nita di Apache 2 utilizza i virtual hosts name-based. Un virtual host di
               default viene de nito nel le /etc/apache2/sites-enabled/000-default.conf; questo virtual
               host sarà utilizzato qualora nessun altro host riesce a stabilire il matching con la richiesta inviata
               dal client.




                                    TDAH_1.0         Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 269
fi
     fi
          fi
               fi
                    fi
                          fi
                               fi
                                      fi
                                           fi
                                                fi
                                                        fi
                                                             fi
                                                                  fi
                                                                                  fi
                                                                                       l

                                                                                                              fi
                                                                                                                      fi
                                                                                                                           fi
                          ATTENZIONE                                               Il primo virtual host risponderà sempre alle richieste concernenti virtual hosts
                     Il primo virtual                                              sconosciuti; pertanto viene con gurato come www.falcot.com.
                     host


                              BREVE                                                Apache supporta un'estensione del protocollo SSL denominata Server Name
                           ACCENNO                                                 Indication (SNI). Questa estensione consente al browser di inviare l’hostname del
                     Apache supporta                                               web server non appena viene stabilita la connessione SSL, prima della stessa
                     SNI                                                           richiesta HTTP, che in passato veniva utilizzata per identi care il virtual host
                                                                                   richiesto tra tutti gli altri ospitati sullo stesso server (con stesso indirizzo IP e
                                                                                   port). Ciò consente ad Apache di selezionare il certi cato SSL più appropriato per
                                                                                   l’operazione da eseguire.
                                                                                   Prima dell'introduzione di SNI, Apache utilizzava sempre il certi cato del virtual
                                                                                   host prede nito. Pertanto quando i clients provavano ad accedere ad un altro
                                                                                   virtual host visualizzavano dei warnings dato che il certi cato non corrispondeva al
                                                                                   sito web a cui stavano tentando di accedere. Fortunatamente la maggior parte dei
                                                                                   browsers di oggi è compatibile con SNI; ovviamente sono inclusi Microsoft Internet
                                                                                   Explorer dalla versione 7.0 (a partire da Vista), Mozilla Firefox dalla versione 2.0,
                                                                                   Apple Safari dalla versione 3.2.1 e tutte le versioni di Google Chrome.
                                                                                   Il pacchetto Apache distribuito da Debian è compilato con il supporto SNI; quindi
                                                                                   non è necessaria alcuna con gurazione speciale.
                                                                                   Occorre anche accertarsi che la con gurazione del primo virtual host (quello
                                                                                   prede nito) abiliti il TLSv1 perché Apache usa i parametri del primo virtual host
                                                                                   per stabilire le connessioni sicure ed è imprescindibile.



                    Gli extra virtual hosts vengono de niti invece da un le archiviato nella directory /etc/apache2/
                    sites-available/. Per con gurare un website con dominio falcot.org si dovrà semplicemente
                    creare il le sottostante e poi attivare il virtual host con a2ensite www.falcot.org.


                                                     Esempio 11.16 Il le /etc/apache2/sites-available/www.falcot.org.conf

                    <VirtualHost *:80
                    ServerName www.falcot.or
                    ServerAlias falcot.or
                    DocumentRoot /srv/www/www.falcot.or
                    </VirtualHost

                    L’Apache server no a questo punto è stato con gurato per utilizzare gli stessi log les per tutti i
                    virtual hosts (con gurazione che potrà comunque essere modi cata includendo le direttive
                    CustomLog nelle descrizioni dei virtual host). È consigliabile pertanto personalizzare il formato del
                    log le per includere il nome del virtual host. Per ottenere ciò, occorre aggiungere un le /etc/
                    apache2/conf-available/customlog.conf che de nisca un nuovo formato per tutti i log les
                    (attraverso la direttiva LogFormat) e procedere alla sua attivazione attraverso a2enconf
                    customlog. È inoltre necessario eliminare (o commentare) la riga CustomLog dal le /etc/
                    apache2/sites-available/000-default.conf.




                    Pagina 270 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
     fi
          fi
               fi
                       fi
                            >

                                 fi
                                      fi
                                           >

                                                fi
                                                     g

                                                          fi
                                                               fi
                                                                    g

                                                                         fi
                                                                              fi
                                                                                            g

                                                                                                 fi
                                                                                                      fi
                                                                                                           fi
                                                                                                                fi
                                                                                                                     fi
                                                                                                                          fi
                                                                                                                               fi
                                                                                                                                    fi
                                                                                                                                         fi
                                                                                                                                          fi
                                                                                                                                               fi
                                                                                                                                                    fi
                                                                   Esempio 11.17 Il le /etc/apache2/conf.d/customlog.conf

                    # New log format including (virtual) host nam
                     LogFormat ”%v %h %l %u %t \”%r\” %>s %b \”%{Referer}i\” \”%{User-Agent}i\”” vhos

                    # Now let’s use this ”vhost” format by defaul
                    CustomLog /var/log/apache2/access.log vhos


                    11.2.3. Common Directives (Le direttive maggiormente utilizzate)

                    Questa paragrafo esamina brevemente alcune delle direttive maggiormente utilizzate per la
                    con gurazione di Apache.
                    Il le di con gurazione principale di solito contiene diversi Directory blocks; quest’ultimi consentono
                    di con gurare speci catamente le funzionalità del server in base alla posizione del le da
                    supportare. I blocchi in genere includono le direttive Options e AllowOverride.

                                                                                   Esempio 11.18 Directory block

                    <Directory /var/www
                    Options Includes FollowSymlink
                    AllowOverride Al
                    DirectoryIndex index.php index.html index.ht
                    </Directory

                    La direttiva DirectoryIndex de nisce l'elenco dei les da utilizzare per veri care se la richiesta di
                    un client è compatibile ad una directory. Il primo le che corrisponde nell’elenco viene utilizzato ed
                    inviato come risposta.

                    Alla direttiva Options segue un elenco di opzioni da abilitare. Il valore None disabilita tutte le
                    opzioni; diversamente All attiva tutte le opzioni tranne MultiViews. Ecco le opzioni esistenti:

                    • ExecCGI indica che è possibile eseguire i CGI scripts.
                    • FollowSymlinks comunica al server che deve tener conto dei collegamenti simbolici, nonché la
                    risposta dovrà includere i contenuti dei targets dei collegamenti simbolici.
                    • SymlinksIfOwnerMatch comunica al server che deve terner conto dei collegamenti simbolici, ma
                    solo se il collegamento simbolico ed il suo target appartengono allo stesso proprietario/owner.
                    • Includes attiva il Server Side Includes (o SSI in breve). Si tratta di direttive direttamente
                    integrate nelle pagine HTML ed eseguite al volo ad ogni richiesta.
                    • Indexes comunica al server di elencare i contenuti della cartella se la richiesta HTTP inviata dal
                    client punta ad una directory priva di un index le (ad esempio quando nessuno dei les menzionati
                    dalla direttiva DirectoryIndex si trova nella directory).
                    • MultiViews attiva la content negotiation (trad. lett. “la negoziazione dei contenuti”); viene
                    utilizzata dal server per restituire la pagina web in base alla lingua prescelta che è stata con gurata
                    nel browser web.




                                        TDAH_1.0   Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 271
fi
     fi
          fi
               fi
                    >

                         fi
                              l

                                   fi
                                        >

                                                    fi
                                                         s

                                                              fi
                                                                              t

                                                                              fi
                                                                                   fi
                                                                                        m

                                                                                             e

                                                                                             t

                                                                                                  fi
                                                                                                                   fi
                                                                                                                        fi
                                                                                                                             fi
                                                                                                                                  t

                                                                                                                                   fi
                                  BASILARE                                    Il le .htaccess contiene le direttive della con gurazione di Apache, prese in
                           .htaccess le                                       esame ogni volta che viene effettuata una richiesta in merito ad un elemento nella
                                                                              directory in cui lo stesso le .htaccess è memorizzato. L’effetto delle direttive del le
                                                                              .htaccess è ricorsivo e pertanto ricade anche sulle subdirectories contenute dalla
                                                                              directory in cui lo stesso le .htaccess si trova.
                                                                              La maggior parte delle direttive che possono essere inserite in un Directory block
                                                                              sono consentite anche in un le .htaccess.


                          La direttiva AllowOverride elenca tutte le opzioni che possono essere abilitate o disabilitate
                          tramite un le .htaccess. Questa opzione viene comunemente utilizzata per limitare l’ExecCGI , in
                          modo che l’amministratore possa scegliere gli utenti autorizzati ad eseguire programmi sotto
                          l’identità del web server (ovvero al di sotto del pro lo utente www-data).


                          11.2.3.1 Come richiedere l’Autenticazione

                          In alcuni casi è necessario limitare l'accesso ad una parte di un sito web, in modo che solo gli utenti
                          autorizzati, immettendo un nome utente ed una password, possano accedere ai suoi contenuti.

                                                               Esempi. 11.19 Il le .htaccess impone la richiesta di autenticazione

                          Require valid-use
                          AuthName ”Private directory
                          AuthType Basi
                          AuthUserFile /etc/apache2/authfiles/htpasswd-privat


                                 SICUREZZA                                    Il sistema di autenticazione (Basic) richiesto nell’esempio soprastante ricorre ad un
                           Nessuna                                            metodo di sicurezza minimale in cui le passwords vengono inviate in chiaro
                           sicurezza                                          (codi cate in base64 - che è una semplice codi ca e non metodo di crittogra a).
                                                                              Inoltre anche i documenti “protetti” da questo meccanismo circolano nella rete in
                                                                              chiaro. Pertanto se per voi la sicurezza conta dovrete criptare l’intera connessione
                                                                              HTTP tramite SSL.


                          Il le /etc/apache2/authfiles/htpasswd-prive contiene l'elenco degli utenti e le loro
                          passwords; il comando htpasswd viene comunemente utilizzato per modi care e gestire il suddetto
                            le. Difatti, come nell’esempio sottostante, il comando htpasswd viene impiegato per aggiungere un
                          utente o modi care le passwords:

                          # htpasswd /etc/apache2/authfiles/htpasswd-private user
                          New password
                          Re-type new password
                          Adding password for user use


                          11.2.3.2 Come limitare l’Accesso

                          La direttiva Require gestisce le restrizioni di accesso ad una directory (ed alle sue subdirectories,
                          ricorsivamente).




                          Pagina 272 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
     fi
      fi
           fi
                fi
                     fi
                            fi
                                 :

                                      c

                                      fi
                                           r

                                                fi
                                                fi
                                                     :

                                                          fi
                                                                    ”

                                                                         r

                                                                                    fi
                                                                                         fi
                                                                                              fi
                                                                                                              e

                                                                                                                   fi
                                                                                                                         

                                                                                                                             fi
                                                                                                                             fi
Questa direttiva può essere utilizzata per limitare l'accesso in base a diversi criteri; qui
descriveremo soltanto le restrizioni di accesso basate sugli indirizzi IP del client, in quanto le
direttive Require se combinate in un blocco RequireAll hanno un effetto più considerevole.


                                         Esempio 11.20 Accesso consentito solo da rete locale

Require ip 192.168.0.0/1




   ALTERNATIVA                      La sintassi Require è disponibile solo a partire dalla versione di Apache 2.4 (la
 Vecchia sintassi                   versione presente in Jessie). La sintassi di Apache 2.2 (la versione disponibile per
                                    gli utenti di Wheezy) è diversa ed è stata qui descritta come mera nozione sebbene
                                    la si possa utilizzare anche con Apache 2.4 attraverso il modulo
                                    mod_access_compat.
                                    Le direttive Allow from e Deny from gestiscono le restrizioni di accesso di una
                                    directory (e ricorsivamente delle sue subdirectories).
                                    La direttiva Order comunica al server in quale ordine deve prendere in esame le
                                    direttive Allow from e Deny from ; la priorità spetta all’ultima direttiva di cui è
                                    possibile il matching. In concreto, Order deny, allow consente l'accesso se non è
                                    possibile il matching di Deny from o se è possibile il matching di Allow from. Al
                                    contrario, Order allow, deny nega l’accesso se nessuna direttiva Allow from
                                    consente il matching (o se è possibile il matching di una direttiva Deny from).
                                    Le direttive Allow from e Deny from possono riguardare un indirizzo IP, una rete
                                    (ad esempio 192.168.0.0/255.255.255.0, 192.168.0.0/24 e persino 192.
                                    168.0), un hostname o un domain name o la keyword all (che equivale a
                                    “chiunque”).
                                    Ad esempio, per vietare le connessioni per impostazione prede nita e consentire le
                                    connessioni provenienti solo dalla rete locale, è possibile utilizzare:
                                    Order deny,allo
                                    Allow from 192.168.0.0/1
                                    Deny from all



11.2.4. Log Analyzers

Spesso viene installato un Log Analyzer sul server web; la ragione è che un Log Analyzer consente
agli amministratori di avere un'idea più precisa in merito ai patterns impiegati sul web server.

Gli amministratori della Falcot Corp hanno scelto AWStats (Advanced Web Statistics) per
analizzare i log les di Apache.

Il primo passo nella con gurazione è personalizzare il le /etc/awstats/awstats.conf. Gli
amministratori della Falcot Corp si sono limitati a modi care i seguenti parametri:




              TDAH_1.0         Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 273
    fi
         w

                fi
                     6

                          6

                                    fi
                                                          fi
                                                               fi
                                                                    fi
          LogFile=”/var/log/apache2/access.log
          LogFormat = ”%virtualname %host %other %logname %time1 %methodurl %code %bytesd
          -> refererquot %uaquot”
          SiteDomain=”www.falcot.com”
          HostAliases=”falcot.com REGEX[^.*\.falcot\.com$]”
          DNSLookup=
          LoadPlugin=”tooltips

          Tutti questi parametri sono documentati attraverso i commenti nel template le [il le usato da
          modello]. In particolare, i parametri LogFile e LogFormat indicano la posizione ed il formato del log
           le e le informazioni in esso contenute; SiteDomain e HostAliases elencano i diversi nomi associati
          al sito web principale.
          Per i siti ad alto traf co e quindi diversamene dall’esempio soprastante della Falcot Corp, non è
          consigliabile impostare il DNSLookup ad 1; d'altra parte, questa impostazione consente ai siti di
          piccole dimensioni, come quello della Falcot Corp, di ottenere reports più human readable in quanto
          includono full machine names anziché raw IP address.



                 SICUREZZA                            Le statistiche di AWStats sono disponibili per impostazione prede nita sul sito web
           Accesso alle                               senza restrizioni, ma potrete comunque con gurarle in modo che solo pochi
                                                      indirizzi IP (solitamente interni) possano accedervi; l'elenco degli indirizzi IP a cui
           statistiche
                                                      è concesso l’accesso deve essere riportato nel parametro
                                                      AllowAccessFromWebToFollowingIPAddresses.



          AWStats verrà abilitato anche per gli altri virtual hosts; ma ciascun virtual hosts necessiterà di un
           le dedicato /etc/awstats/awstats.www.falcot.org.conf.


                                       Esempio. 11.21 Il le di con gurazione AWStats dedicato ad un virtual host


          Include ”/etc/awstats/awstats.conf
          SiteDomain=”www.falcot.org
          HostAliases=”falcot.org


          AWStats utilizza diverse icone memorizzate nella directory /usr/share/awstats/icon/. Per
          renderle disponibili sul sito web, è necessario modi care la con gurazione di Apache in modo che
          includa la seguente direttiva:

          Alias /awstats-icon/ /usr/share/awstats/icon

          Dopo pochi minuti (ed una volta che lo script verrà eseguito un paio di volte), i risultati saranno
          disponibili online:

            http://www.falcot.com/cgi-bin/awstats.pl
            http://www.falcot.org/cgi-bin/awstats.pl




          Pagina 274 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
fi
     1

              fi
                   fi
                        ”

                             fi
                                   

                                       ”

                                             

                                                 ”

                                                          fi
                                                               ”

                                                                    ”

                                                                         fi
                                                                              /

                                                                                

                                                                                    fi
                                                                                         fi
                                                                                                     fi
                                                                                                             fi
                                                                                                                     %

                                           ATTENZIONE                            Af nché le statistiche di AWStats tengano conto di tutti i logs, è necessario che
                                        Log le rotation                          AWStats venga messo in esecuzione prima che i log les di Apache vengano ruotati.
                                                                                 La direttiva prerotate del le /etc/logrotate.d/apache2 fornisce gli elementi
                                                                                 utili per risolvere il problema ossia attraverso la creazione di un sym link (un
                                                                                 collegamento simbolico) a /usr/share/awstats/tools/update.sh nella
                                                                                 directory /etc/logrotate.d/httpd-prerotate :

                                                                                 $ cat /etc/logrotate.d/apache2
                                                                                 /var/log/apache2/*.log
                                                                                   dail
                                                                                   missingo
                                                                                   rotate 1
                                                                                   compres
                                                                                   delaycompres
                                                                                   notifempt
                                                                                   create 644 root ad
                                                                                   sharedscript
                                                                                   postrotat
                                                                                     if /etc/init.d/apache2 status > /dev/null ; then
                                                                                        /etc/init.d/apache2 reload > /dev/null;
                                                                                     fi
                                                                                   endscrip
                                                                                   prerotat
                                                                                 if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
                                                                                          run-parts /etc/logrotate.d/httpd-prerotate;
                                                                                     fi;
                                                                                   endscrip

                                                                                 $ sudo mkdir -p /etc/logrotate.d/httpd-prerotate
                                                                                 $ sudo ln -sf /usr/share/awstats/tools/update.sh
                                                                                 /etc/logrotate.d/httpd-prerotate/awstat

                                                                                 Dovrete assicurarvi che chiunque abbia i permessi di lettura dei log les creati da
                                                                                 logrotate, in particolare AWStats. Nell'esempio soprastante ciò viene garantito
                                                                                 dalla riga create 644 root adm, (che in sostanza si occupa della sostituzione dei
                                                                                 permessi 640 prede niti).




                                   11.3. FTP File Server

                                   Il File Transfer Protocol (FTP) è stato uno dei primi protocolli su Internet (l’RFC 959 è stato
                                   emesso nel 1985!). Questo protocollo è stato utilizzato per distribuire les prima dell'invenzione del
                                   Web (il protocollo HTTP è stato creato nel 1990 e formalmente de nito nell’ RFC 1945 rilasciato nel
                                   1996).

                                   Questo protocollo consente l’upload ed il download dei les; per tale ragione è ancora comunemente
                                   impiegato per il deployment degli aggiornamenti di un sito web ospitato da un provider di servizi
                                   Internet (o da una terza parte che ospita siti web). Generalmente viene imposto il secure access
                                   attraverso l’user identi er (UID) e password; se l’autenticazione ha buon ne l’FTP server concede i
                                   permessi di lettura e scrittura per accedere all’user’s home directory.




                                                    TDAH_1.0             Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 275
}

     fi
          fi
               y

               ;

                    \

                         s

                              4

                              k

                              e

                              t

                              t

                                   y

                                   e

                                          s

                                          s

                                               fi
                                                     m

                                                          fi
                                                               fi
                                                                    {

                                                                             

                                                                                 fi
                                                                                          s

                                                                                               fi
                                                                                                    \

                                                                                                         fi
                                                                                                          

                                                                                                              \

                                                                                                                    

                                                                                                                        \

                                                                                                                             \

                                                                                                                                  fi
                                                                                                                                       fi
                                                                                                                                            fi
                                                                                                                                                 fi
          Inoltre gli FTP servers vengono utilizzati anche per distribuire les per il public downloading; i
          pacchetti Debian sono un esempio di public downloading. I contenuti degli FTP servers vengono
          recuperati da altri servers, geogra camente remoti; dopodiché quest’ultimi, essendo meno remoti
          nei confronti degli utenti, rendono disponibili i contenuti all’utenza. In questo caso, l'autenticazione
          del client non è necessaria; questo sistema viene de nito “anonymous FTP”. In realtà anche in questo
          caso l’FTP server effettua un’autenticazione solo che i clients si identi cano con l’username
          anonymous ed una password che per convenzione è l'indirizzo di posta elettronica dell'utente.

          Diversi FTP servers sono distribuiti da Debian (ftpd, proftpd-basic, pyftpd, ecc.). Gli
          amministratori della Falcot Corp hanno scelto vsftpd perché necessitano di un FTP server solo per
          distribuire pochi les (ed un repository di pacchetti Debian); per di più gli amministratori della
          Falcot Corp non avendo bisogno di funzionalità complesse hanno preferito concentrarsi sulla
          sicurezza.

          L'installazione del pacchetto crea un ftp system user. Questo account viene sistematicamente
          utilizzato per le connessioni anonymous FTP e la sua home directory (/srv/ftp/) è la radice (root)
          della struttura ad albero messa a disposizione degli utenti che si connettono al servizio. La
          con gurazione prede nita (che si trova nel le /etc/vsftpd.conf) richiede alcune modi che per
          soddisfare la mera esigenza di fruibilità di les di grandi dimensioni per il downloading pubblico:
          l’anonymous access deve essere abilitato (anonymous=YES) mentre il permesso di sola lettura (read-
          only) degli utenti locali deve essere disabilitato (local_enable=NO). Quest'ultimo punto è
          particolarmente importante dato che il protocollo FTP non fa uso di alcuna forma di crittogra a e la
          password dell'utente potrebbe essere intercettata da una connessione via cavo.


          11.4. NFS File Server

          NFS (Network File System) è un protocollo che consente l'accesso remoto ad un lesystem
          attraverso la rete. Questo protocollo è supportato da tutti i sistemi Unix; se sono presenti delle
          macchine Windows, dovrete invece usare Samba.

          Sebbene NFS sia uno strumento molto utile, in passato presentava diverse limitazioni, la maggior
          risolte con la versione 4 del protocollo. Purtroppo però l'ultima versione di NFS è complessa da
          con gurare se si desidera sfruttare delle funzionalità di sicurezza di base come l'autenticazione e la
          crittogra a, dato che si basano su Kerberos. E senza tali funzionalità, il protocollo NFS può essere
          utilizzato solo su una rete locale data, perché i dati che circolano sulla rete non sono crittografati
          (uno sniffer può intercettarli) ed i permessi di accesso vengono concessi solo in base all'indirizzo
          IP del client (che può essere falsi cato - spoofing).




           DOCUMENTAZIONE                  La documentazione sul deployment di NFSv4 è abbastanza scarna. In basso sono
           NFS howto                       riportati alcuni collegamenti dai contenuti di qualità varia che potranno fungere
                                           da punto di partenza su come procedere.

                                             https://help.ubuntu.com/community/NFSv4Howto
                                             http://wiki.linux-nfs.org/wiki/index.php/Nfsv4_con guration




          Pagina 276 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
fi
     fi
                fi
                     fi
                                 fi
                                 fi
                                      fi
                                               fi
                                                    fi
                                                         fi
                                                              fi
                                                                      fi
                                                                             fi
                                                                                          fi
                                                                                                   fi
                                                                                                        fi
                    11.4.1. Securing NFS [come con gurare le funzionalità di sicurezza di NFS]

                    Se non desiderate impiegare le funzionalità di sicurezza basate su Kerberos, dovrete assicurarvi che
                    solo delle macchine autorizzate possano usufruire di NFS e connettersi ai diversi RFC servers,
                    perché il protocollo di base fondamentalmente considera dati i dati ricevuti dalla rete. Il rewall
                    deve essere in grado di impedire lo spoo ng dell'indirizzo IP in modo da scongiurare che una
                    macchina esterna possa agire con l’identitità di una macchina interna, imponendo delle restrizioni a
                    dei ports speci ci, impiegati dalle macchine che intendono accedere alle condivisioni NFS.


                            BASILARE                         RPC (Remote Procedure Call) è uno standard Unix per i servizi remoti, tra cui
                     RPC                                     NFS.
                                                             I servizi RPC vengono registrati in una directory nota come portmapper. Un client
                                                             che desidera effettuare una NFS query la indirizza prima al portmapper (sul port
                                                             111 in TCP o UDP) per chiedere informazioni sull’NFS server; la risposta di solito
                                                             indica il port 2049 (di default per NFS). Non tutti i servizi RPC fanno uso di un port
                                                             prede nito.


                    Le versioni precedenti del protocollo richiedevano ulteriori servizi RPC che impiegavano i ports
                    assegnati dinamicamente. Fortunatamente, la versione 4 di NFS necessita solo dei ports 2049 (per
                    NFS) e 111 (per il portmapper), rendendo più facile il compito del rewall.


                    11.4.2. NFS Server

                    L’NFS server è integrato nel kernel di Linux; Debian lo distribuisce compilato come modulo del
                    kernel. Per attivarlo automaticamente ad ogni avvio, è necessario installare il pacchetto nfs-
                    kernel-server; questo pacchetto include gli start-up scripts pertinenti.

                    Il le di con gurazione dell’NFS server, /etc/exports, elenca le directories rese disponibili sulla
                    rete (exported). Ciascun NFS share riserva l’accesso a delle date macchine. Qualora necessitiate di
                    un access control più “fine-grained” vi basteranno poche opzioni. La sintassi di questo le è
                    abbastanza semplice:

                    /directory/to/share machine1(option1,option2,...) machine2(...) ..

                    Si precisa che l’NFSv4 prevede che tutte le directories esportate devono far parte di un singola
                    gerarchia e che la root directory della gerarchia deve essere esportata ed identi cata con l'opzione
                    fsid=0 o fsid=root.

                    Ogni macchina può essere identi cata per mezzo del suo nome DNS o attraverso il suo indirizzo IP. È
                    anche possibile speci care un intero set di macchine utilizzando la sintassi *.falcot.com oppure
                    indicare un IP address range come ad esempio 192.168.0.0/255.255.255.0 o 192.168.0.0/24.

                    Le directories vengono condivise soltanto in modalità read-only (in breve ro) - “lettura”.
                    L'opzione rw (read-write) consente sia la lettura che la scrittura. Gli NFS clients per impostazione
                    prede nita si connettono ad un port riservato solo al root (con un numero di port inferiore a 1024 -
                    1024 non compreso) [tale restrizione consente l’accesso all’NFS share solo agli users delle macchine
                    con titolarità dei diritti e dei permessi equivalenti a quelli di root]; diversamente se non si desidera
                    tale restrizione occorre attivare l’“insecure option” (la “secure option” è implicita, ma per maggiore
                    trasparenza potrà comunque essere menzionata).

                    Il server per impostazione prede nita non risponde a una NFS query se l’operazione sul disco in atto
                    non è stata completata (a causa della sync option); la async option disattiva la sync option.




                                  TDAH_1.0   Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 277
fi
     fi
          fi
               fi
                      fi
                             fi
                                              fi
                                                   fi
                                                        fi
                                                             fi
                                                                  fi
                                                                                     fi
                                                                                                fi
                                                                                                               fi
                                                                                                                    .

                                                                                                                          fi
                                                                                                                               fi
               La modalità di scrittura asincrona migliora leggermente le prestazioni, a discapito dell'af dabilità
               (reliability) essendoci il rischio fondato di perdita di dati a causa di un ipotetico crash del server
               durante la fase di acknowledgement [non lett. “ricezione”] sia dei dati scritti, sia dei dati in corso di
               scrittura. Dato che il suo valore prede nito è cambiato di recente (rispetto al valore storico di NFS),
               si consiglia una con gurazione esplicita.
               Per evitare di concedere il root access al lesystem a qualsiasi client NFS, tutte le queries (richieste)
               apparentemente provenienti da un root user vengono considerate dal server come queries del
               nobody user. Tale funzionalità corrisponde all’opzione root_squash , abilitata per impostazione
               prede nita. Diversamente l'opzione no_root_squash, che disabilita la suddetta funzionalità, è
               rischiosa e dovrebbe essere usata soltanto in un controlled environment [lett. “ambiente
               controllato”]. Le opzioni anonuid=uid e anongid=gid consentono di impostare un altro fake user da
               utilizzare al posto di UID/GID 65534 (che corrisponde all’ user nobody ed al group nogroup).
               L’NFSv4 consente di aggiungere un'opzione sec per speci care il livello di sicurezza desiderato:
               sec=sys è il valore prede nito senza alcuna sicurezza particolare, sec=krb5 attiva solo
               l'autenticazione, sec=krb5i aggiunge l’integrity protection e sec=krb5p è il livello più alto che
               include la privacy protection (per mezzo della crittogra a dei dati). Af nché tutto ciò funzioni, è
               necessario con gurare Kerberos (ma questo servizio non viene trattato da questo libro).
               Ci sono anche altre opzioni disponibili, che troverete nella man page exports (5).


                     ATTENZIONE                  Il boot script /etc/init.d/nfs-kernel-server avvia il server solo se il le /etc/
                Installazione                    export elenca uno o più NFS share validi. Dopo la con gurazione iniziale del
                iniziale                         suddetto le dovrete avviare il server NFS con il seguente comando:

                                                 # service nfs-kernel-server start




               11.4.3. NFS Client

               Come gli altri lesystems, per integrare l’NFS share nella gerarchia di un le system dovrete
               eseguirne il mounting. Dato che si tratta di un lesystem con delle particolari speci che, dovrete
               effettuare delle modi che sfruttando la sintassi del comando mount ed il le /etc/fstab.

                                               Esempio 11.22 Montaggio manuale attraverso il comando mount

               # mount -t nfs4 -o rw,nosuid arrakis.internal.falcot.com:/shared /srv/
               -> share

                                                             Esempio 11.23 L’NFS entry del le /etc/fstab

               arrakis.internal.falcot.com:/shared /srv/shared nfs4 rw,nosuid 0



               L’entry precedentemente descritta monta automaticamente al system startup la directory NFS /
               share/ del server arrakis nella directory locale /srv/share/ .




               Pagina 278 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
     fi
          d

                 fi
                      fi
                           fi
                                fi
                                     fi
                                          fi
                                                   fi
                                                        fi
                                                                  fi
                                                                       fi
                                                                             fi
                                                                                  fi
                                                                                       fi
                                                                                            fi
                                                                                                 fi
                                                                                                 fi
                                                                                                      0

                                                                                                           fi
                                                                                                                 

                                                                                                                     fi
     La modalità di accesso necessaria è di read/write [lettura/scrittura] (ovvero il parametro rw).
     L'opzione nosuid è una misura di sicurezza che rimuove qualsiasi setuid o setgid presente sui
     programmi contenuti nella condivisione. Se l’NFS share è dedicato solo all'archiviazione dei
     documenti, si consiglia di utilizzare anche l'opzione noexec che impedisce la messa in esecuzione di
     eventuali programmi archiviati nell’NFS share. Si precisa che sul server, la directory shared è una
     subdirectory dell’NFSv4 root export (ad esempio /export/shared) e quindi non una top-level
     directory.
     La man page nfs(5) descrive in dettaglio tutte le possibili opzioni.


     11.5. Con gurare Windows Shares attraverso Samba

     Samba è una suite di strumenti per la gestione del protocollo SMB (denominato anche "CIFS") in
     Linux. Il protocollo SMB viene utilizzato da Windows per accedere alle condivisioni di rete e alle
     stampanti condivise.
     Samba è in grado anche di svolgere il ruolo di Windows domain controller. Questo strumento
     straordinario garantisce una perfetta coesistenza tra servers Linux e desktop aziendali che
     eseguono ancora Windows.


     11.5.1. Samba Server

     Il pacchetto samba di Debian include i due principali servers di Samba 4, smbd e nmbd.




      DOCUMENTAZIONE                       Il server Samba è estremamente con gurabile e versatile, difatti può soddisfare
      Approfondimento                      diversi use cases con differenti esigenze di speci che ed architetture di rete.
                                           Questo manuale si concentra su un solo use case in cui Samba viene utilizzato
                                           come standalone server, ma in realtà può svolgere il ruolo anche di un NT4
                                           Domain Controller, di un full Active Directory Domain Controller oppure
                                           semplicemente essere parte di un pre-esistente dominio (che potenzialmente
                                           potrebbe essere gestito da un Windows server).
                                           Il pacchetto samba-doc contiene un ingente numero di example les
                                           commentati in /usr/share/doc/samba-doc/examples/.




       STRUMENTI TOOLS                     Winbind consente agli amministratori di sistema di utilizzare un Windows
      L’autenticazione                     server come un authentication server. Winbind inoltre si integra perfettamente
                                           con PAM e NSS. Ciò consente di con gurare macchine Linux in cui tutti gli utenti
      attraverso un
                                           di un Windows domain riceveranno automaticamente un account.
      Windows server                       Troverete maggiori informazioni nella directory /usr/share/doc/samba-doc/
                                           examples/pam_winbind/.




     11.5.1.1 Con gurazione con debconf

     Il pacchetto imposta una con gurazione minimale durante l'installazione iniziale, ma è preferibile
     che eseguiate il comando dpkg-reconfigure samba-common per personalizzarla.
     La prima informazione richiesta è il nome del workgroup in cui il Samba server verrà integrato (la
     risposta nel caso della Falcot è FALCOTNET).




              TDAH_1.0          Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 279
fi
      fi
                      fi
                           fi
                                 fi
                                      fi
                                                 fi
                                                                fi
                    Il pacchetto propone inoltre l’identi cazione del WINS server attraverso le informazioni fornite dal
                    demone DHCP. Gli amministratori della Falcot Corp hanno preferito ri utare questa opzione, poiché
                    intendono utilizzare lo stesso Samba server come WINS server.


                    11.5.1.2 Con gurazione manuale

                    11.5.1.2.1 Le modi che a smb.conf Le esigenze della Falcot impongono che debbano essere
                    modi cate altre opzioni nel le di con gurazione di Samba /etc/samba/smb.conf. I seguenti
                    estratti riportano le modi che apportate all'interno della sezione [global].

                    [global

                    ## Browsing/Identification ##

                    # Change this to the workgroup/NT-domain name your Samba server will part of
                    workgroup = FALCOTNE

                    # Windows Internet Name Serving Support Section
                    # WINS Support - Tells the NMBD component of Samba to enable its WINS Serve
                    wins support=yes (1)

                    [...

                    ####### Authentication ######

                    #     Server role. Defines in which mode Samba will operate. Possibl
                    #     values are ”standalone server”, ”member server”, ”classic primar
                    #     domain controller”, ”classic backup domain controller”, ”active
                    #     directory domain controller”

                    # Most people will want ”standalone sever” or ”member server”
                    # Running as ”active directory domain controller” will require firs
                    # running ”samba-tool domain provision” to wipe databases and create a
                    # new domain
                       server role = standalone serve
                    # ”security = user” is always a good idea. This will require a Unix accoun
                    # in this server for every user accessing the server
                     security=user (2)

                    [...


                    (1) Speci ca che Samba deve svolgere il ruolo nella rete locale di Netbios name server (Wins).
                    (2) Questo è il valore prede nito per tale parametro; tuttavia, essendo di particolare importanza per
                    la con gurazione di Samba, viene comunque dichiarato esplicitamente. Ogni utente deve
                    autenticarsi prima di poter accedere a qualsiasi condivisione.




                    Pagina 280 Il Manuale dell’Amministratore di Debian TDAH_1.0
#

     fi
     ]

     ]

          fi
               fi
               ]

                     fi
                          .

                               fi
                                     

                                          

                                              T

                                                   fi
                                                        fi
                                                             fi
                                                                  fi
                                                                       #

                                                                       #

                                                                            fi
                                                                                 .

                                                                                      r

                                                                                           :

                                                                                                .

                                                                                                     fi
                                                                                                          .

                                                                                                               e

                                                                                                                     

                                                                                                                         y

                                                                                                                              t

                                                                                                                                    

                                                                                                                                        t

                                                                                                                                             r

                                                                                                                                                   

          11.5.1.2.2 Come aggiungere gli Utenti Ciascun utente di Samba necessita di un account sul server;
          devono essere creati prima gli account Unix e poi è necessario registrarli nel database di Samba. La
          creazione degli account Unix solitamente è quella consueta (con il comando adduser per esempio).
          Per aggiungere un utente Unix al database Samba dovrete eseguire il comando smbpasswd -a user;
          il comando vi richierà in risposta la password.
          Un utente può essere rimosso con il comando smbpasswd -x user. Un account Samba può essere
          temporaneamente disabilitato con il comando smbpasswd -d user e poi riattivato con il comando
          smbpasswd -e user.


          11.5.2. Samba Client

          Le client features in Samba consentono ad una macchina Linux di accedere alle condivisioni
          Windows ed alle stampanti condivise. I programmi necessari sono inclusi nei pacchetti Debian cifs-
          utils e smbclient.


          11.5.2.1 Il programma smbclient

          Il programma smbclient interroga tutti i servers SMB. Accetta l'opzione -U user per connettersi al
          server con un'identità speci ca. Attraverso smbclient //server/share l’accesso alla condivisione
          avverrà in modalità interattiva similmente ad un FTP client da riga di comando. Il comando
          smbclient -L server elenca tutte le condivisioni sul server disponibili (e visibili).


          11.5.2.1 Mounting delle Windows Shares

          Il comando mount consente il mounting di una Windows share nella gerarchia ad albero del
            lesystem di Linux (per mezzo di mount.cifs supportato da cifs-utils).

                                                     Esempio 11.24 Mounting di una Windows share


          mount -t cifs //arrakis/shared /shared
                -o credentials=/etc/smb-credential

          Il le /etc/smb-credentials (che non dovrà essere leggibile dagli utenti) presenta il seguente
          formato:

          username = user
          password = password

          Possono essere de nite altre opzioni da riga di comando; l’elenco completo di tali opzioni si trova in
          mount.cifs(1). In particolare due opzioni sono meritevoli di essere menzionate: uid e gid che
          consentono rispettivamente di forzare l’accesso dei les disponibili sul mount al loro owner (uid) ed
          al loro group (gid) in modo che la disponibilità dei suddetti les non venga limitata solo a root.
          È anche possibile con gurare il mounting di una Windows share in /etc/fstab:

          //server/shared /shared cifs credentials=/etc/smb-credential




                               TDAH_1.0   Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 281
fi
     fi
                fi
                      

                          fi
                                     fi
                                               fi
                                                               \

                                                                    s

                                                                         fi
                                                                              fi
                                                                                               s

     L’unmounting di una SMB/CIFS share può essere effettuato attraverso il comando umount standard.


     11.5.2.3 Come stampare su una stampante condivisa

     CUPS è una soluzione elegante per stampare da una workstation Linux su una stampante condivisa
     da una macchina Windows. Se smbclient è installato, CUPS offre la possibilità di installare
     automaticamente le stampanti condivise attraverso Windows.

     I passaggi necessari sono i seguenti:
     • Accedete all'interfaccia di con gurazione di CUPS: http://localhost:631/admin
     • Fate clic su "Add Printer".
     • Scegliete il dispositivo di stampa, selezionando “Windows Printer via SAMBA”.
     • Immettete la connessione URI della stampante di rete. Dovrete rispettare il seguente formato:
     smb://user:password@server/printer.
     • Immettete il nome che identi cherà in modo univoco la stampante. Dopodiché inserite una
     descrizione e la posizione della stampante. Queste stringhe vengono utilizzate per consentire agli
     utenti di identi care le stampanti.
     • Indicate il nome del produttore ed il modello della stampante oppure rilasciate direttamente un
       working printer description le (PPD).

     E voilà, la stampante sarà funzionale!


     11.6. Proxy HTTP/FTP

     Un proxy HTTP/FTP fa da intermediario per le connessioni HTTP e/o FTP. Il suo ruolo è duplice:

     • Caching: conserva localmente una copia dei documenti scaricati recentemente, per evitare che gli
     stessi les vengano scaricati più volte.
     • Filtering server: se è stato delegato [in inglese “mandated”] un proxy, le connessioni in uscita
     devono obbligatoriamente attraversarlo altrimenti verranno bloccate e pertanto è il proxy a stabilire
     quali richieste sono legittime oppure no.

     Il server proxy utilizzato dalla Falcot Corp è Squid.


     11.6.1. Installazione

     Il pacchetto Debian squid3 contiene solo un modular (caching) proxy. La conversione in un ltering
     server richiede che venga aggiunto il pacchetto squidguard. Il pacchetto squid-cgi supporta
     un’interfaccia per il querying e l’amministrazione di un proxy Squid.




     Pagina 282 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
        fi
                       fi
                            fi
                                 fi
                                                                                      fi
                          Prima dell'installazione dovrete avere cura di veri care che il sistema sia in grado di identi care il
                          suo stesso nome completo: il comando hostname -f dovrebbe restituirvi un fully-quali ed name
                          (che includa un dominio). In caso contrario, dovrete modi care /etc/hosts in modo che contega il
                          full name del sistema (per esempio: arrakis.falcot.com). Dovrete accordarvi per la scelta del
                          nome uf ciale del computer con l’amministratore di rete così da scongiurare potenziali con itti per i
                          nomi.


                          11.6.2. Con gurazione di una cache

                          Per abilitare la caching server feature dovrete modi care il le di con gurazione /etc/squid3/
                          squid.conf per consentire alle macchine di eseguire le queries dalla rete locale attraverso il proxy.
                          L'esempio seguente mostra le modi che apportate dagli amministratori della Falcot Corp.

                                                                                         Esempio 11.25 Estratti del le /etc/squid3/squid.conf

                          # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENT

                          # Example rule allowing access from your local networks. Adapt
                          # to list your (internal) IP networks from where browsing should
                          # be allowe
                          acl our_networks src 192.168.1.0/24 192.168.2.0/2
                          http_access allow our_network
                          http_access allow localhos
                          # And finally deny all other access to this prox
                          http_access deny al


                          11.6.3. Come con gurare un ltro

                          squid non si occupa del ltering; questa operazione viene delegata a squidGuard. Dovrete pertanto
                          con gurare squid af nché interagisca con squidGuard. Ovvero dovrete aggiungere la seguente
                          direttiva al le /etc/squid3/squid.conf:

                          url_rewrite_program /usr/bin/squidGuard -c /etc/squid3/squidGuard.con

                          Dovrete installare anche il programma CGI /usr/lib/cgi-bin/squidGuard.cgi utilizzando come
                          modello il le /usr/share/doc/squidguard/examples/squidGuard.cgi.gz. Occorre inoltre
                          modi care questo script attraverso le variabili $proxy (nome del server proxy) e $proxymaster
                          (l’email di contatto dell'amministratore). Le variabili $image e $redirect dovranno puntare alle
                          immagini esistenti, che simboleggiano il ri uto della query.
                          Il comando che attiva il ltro è service squid3 reload. Il pacchetto squidguard non offre un
                            ltering prede nito, pertanto dovrà essere l'amministratore a con gurarne la policy.
                          L’amministratore per fare ciò dovrà creare il le /etc/squid3/squidGuard.conf (usando al
                          bisogno come modello /etc/squidguard/squidGuard.conf.default).




                                                   TDAH_1.0         Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 283
fi
     fi
          fi
               fi
                    fi
                         fi
                          fi
                               d

                                    fi
                                         fi
                                              fi
                                                     fi
                                                     l

                                                          fi
                                                          fi
                                                               fi
                                                                     t

                                                                          fi
                                                                               fi
                                                                                    s

                                                                                            fi
                                                                                                 fi
                                                                                                      fi
                                                                                                           fi
                                                                                                                fi
                                                                                                                     fi
                                                                                                                          y

                                                                                                                               4

                                                                                                                                    fi
                                                                                                                                         fi
                                                                                                                                               

                                                                                                                                                   S

                                                                                                                                                         

                                                                                                                                                             fi
                                                                                                                                                             f

                                                                                                                                                                  fi
                                                                                                                                                                  fl
Dopo ogni modi ca del le di con gurazione di squidGuard (o di uno qualsiasi degli elenchi di
domini o di URLs in esso menzionati), è necessario rigenerare il database in funzione attraverso il
comando update-squidguard. La sintassi del le di con gurazione è documentata nel seguente sito
web:

  http://www.squidguard.org/Doc/con gure.html


   ALTERNATIVA               Il pacchetto dansguardian è un'alternativa a squidguard. Questo software non
 DansGuardian                solo gestisce una blacklist degli URLs proibiti, ma può fare rifermento al sistema
                             PICS (Platform for Internet Content Selection) per decidere se una pagina è
                             accettabile o meno attraverso una dynamic analysis sui suoi contenuti.



11.7. LDAP Directory

L’OpenLDAP è un implementazione del protocollo LDAP; in poche parole è un special-purpose
database designato allo storing directories. [In elettronica special-purpose assume il signi cato di
“con compiti speci ci”, diversamente general-purpose assume il signi cato di “con compiti
generici”. Lo “storing directories” si riferisce alla mera conservazione delle informazioni delle
directories; tali informazioni sono necessarie per la condivisione stessa delle directories sulla rete].
Nella maggior parte degli use cases, l’impiego di un LDAP server consente la centralizzazione della
gestione degli accounts degli utenti e della loro correlata titolarità dei diritti. Inoltre, un database
LDAP è agevole da duplicare, il che permette la con gurazione di multiple synchronized LDAP
servers. In caso di una repentina crescita della rete e dell’utenza, potrete distribuire il carico tra i
diversi servers.
I dati LDAP sono organizzati in una gerarchia. Tale struttura gerarchizzata è de nita "schema" e
quest’ultima dichiara gli oggetti che il database può memorizzare per mezzo di un elenco di tutti i
loro possibili attributi. La sintassi utilizzata per richiamare un oggetto del database ri ette la
suddetta struttura e di conseguenza ne spiega la complessità.


11.7.1. Installazione

Il pacchetto slapd contiene il server OpenLDAP. Il pacchetto ldap-utils contiene invece le utilità
da riga di comando per interagire con i servers LDAP.
Purtroppo l’installazione del pacchetto slapd pone poche domande e l’effetto di ciò è un database
che raramente soddisfa delle peculiari esigenze. Ma per rimediare dovrete solo eseguire il comando
dpkg-reconfigure slapd per ricon gurare dettagliatamente il database LDAP:
• Omit OpenLDAP server con guration? - Desiderate saltare la con gurazione dell'OpenLDAP
server? Rispondete “NO”, in quanto desiderate con gurare questo servizio.
• DNS domain name - Qual è DNS domain name? "falcot.com".
• Organization name - Qual è il nome dell'organizzazione-società? "Falcot Corp".
• An administrative passwords needs to be typed in. Occorre immettere una password per
l’amministratore.
• Database backend to use - Database backend da utilizzare? "MDB".
• Do you want the database to be removed when slapd is purged? - Il database deve essere rimosso
se il pacchetto slapd viene “purged”? Rispondete di “No”. In questo modo qualora il summenzionato
pacchetto fosse “purgato” per sbaglio non rischierete di perdere anche il database.
• Move old database? - Il precedente database deve essere spostato? Questa domanda viene posta
solo se viene richiesta una nuova con gurazione e se già esiste un database. Rispondete di "SI" solo
se volete effettuare un’installazione pulita del database ad esempio dopo un’installazione iniziale non
congeniale e dopo aver eseguito dpkg-reconfigure slapd.




Pagina 284 Il Manuale dell’Amministratore di Debian TDAH_1.0
   fi
        fi
             fi
                   fi
                        fi
                             fi
                                  fi
                                       fi
                                            fi
                                                 fi
                                                      fi
                                                           fi
                                                                fi
                                                                     fi
                                                                             fi
                                                                                   fl
                                                                                           fi
                         • Allow LDAPv2 protocol? - Volete consentire il protocollo LDAPv2? No, non ne vale la pena. Tutti i
                           tools che verranno impiegati sono compatibili con il protocollo LDAPv3.



                                  BASILARE                                           Un LDIF le (LDAP Data Interchange Format) è un portable text le che descrive i
                             Formato LDIF                                            contenuti (tutti o in parte) di un database LDAP in modo che possa essere usato per
                                                                                     integrare i dati in qualunque altro server LDAP.


                         Giunti a questo punto otterrete la con gurazione di un minimal database, che potrete veri care
                         utilizzando la seguente query:

                         $ ldapsearch -x -b dc=falcot,dc=com
                         # extended LDI

                         #        LDAPv
                         #        base <dc=falcot,dc=com> with scope su
                         #        filter: (objectclass=*
                         #        requesting: AL

                         # falcot.co
                         dn: dc=falcot,dc=co
                         objectClass: to
                         objectClass: dcObjec
                         objectClass: organizatio
                         o: Falcot Cor
                         dc: falco

                         # admin, falcot.co
                         dn: cn=admin,dc=falcot,dc=co
                         objectClass: simpleSecurityObjec
                         objectClass: organizationalRol
                         cn: admi
                         description: LDAP administrato

                         # search resul
                         search:
                         result: 0 Succes

                         # numResponses:
                         # numEntries:

                         La query dell’esempio soprastante ha restituito due oggetti: l'organizzazione e l’utente con il ruolo di
                         amministratore.




                                                       TDAH_1.0             Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 285
#

#

     fi
          3

               n

               2

                    t

                             m

                                   p

                                        F

                                        t

                                        2

                                             p

                                                  L

                                                  3

                                                  s

                                                        m

                                                             m

                                                                  t

                                                                       )

                                                                       n

                                                                                m

                                                                                     fi
                                                                                          fi
                                                                                               e

                                                                                               r

                                                                                                    t

                                                                                                          

                                                                                                              b

                                                                                                                   fi
                                                                                                                                                  fi
          11.7.2. Compilazione nella directory

          Dato che un database vuoto non ha alcuna utilità, occorre iniettargli tutte le directory esistenti,
          inclusi i database riguardanti gli utenti, i gruppi, i servizi e gli hosts.
          Il pacchetto Debian migrationtools offre una serie di scripts dedicati all’estrazione dei dati dalle
          directories Unix standard (/etc/passwd, /etc/group, /etc/services, /etc/hosts, ecc.),
          conversione e loro iniezione nel database LDAP.
          Dopo aver installato il pacchetto, dovrete modi care il le /etc/migrationtools/
          migrate_common.ph ; dovrete anche attivare le opzioni IGNORE_UID_BELOW e IGNORE_GID_BELOW
          (basta solo rimuovere il commento) ed aggiornare DEFAULT_MAIL_DOMAIN/DEFAULT_BASE.
          In concreto la migrazione viene gestita dal comando migrate_all_online.sh come segue:

          # cd /usr/share/migrationtool
          # LDAPADD=”/usr/bin/ldapadd -c” ETC_ALIASES=/dev/null ./migrate_all_online.s

          Lo script migrate_all_online.sh pone alcune domande a cui è necessario rispondere sul database
          LDAP su cui verrà eseguita la migrazione dei dati.


           Domande                                                       Risposte
           X.500 naming context                                          dc=falcot,dc=com
           LDAP server hostname Manager DN                               localhost cn=admin,dc=falcot,dc=com
           Bind credentials (Credenziali Bind)                           administrative password
           Create DUACon gPro le (Crea un                                no
           DUACon gPro le)




                      Tavola 11.1 Riassume le risposte alle domande poste dallo script migrate_all_online.sh

          Il le /etc/aliases è stato intenzionalmente non tenuto in considerazione per la migrazione, dato
          che lo schema standard supportato da Debian non include le strutture che il suddetto script impiega
          per descrivere gli alias di posta elettronica. Essendo necessario integrare questi dati nella directory,
          bisogna aggiungere il le /etc/ldap/schema/misc.schema come schema standard.


                STRUMENTI            Il comando jxplorer (dall'omonimo pacchetto Debian) è uno strumento gra co che
                      TOOLS          consente di consultare e modi care un LDAP database. È tool notevole in quanto
           Come consultare           fornisce all’amministratore una buona panoramica della struttura gerarchica dei
                                     dati LDAP.
           una directory
           LDAP


          È possibile utilizzare anche l'opzione -c del comando ldapadd; questa opzione impone che il
          processo non si fermi in caso di errore. Potrebbe servire per la conversione del le /etc/services
          che spesso genera alcuni errori che possono essere tranquillamente ignorati.




          Pagina 286 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
     fi
            fi
                 fi
                      fi
                           fi
                                fi
                                     s

                                                 fi
                                                          fi
                                                                            fi
                                                                                      fi
                                                                                                      h

     11.7.3. La gestione degli Accounts con LDAP

     Giunti a questo punto l’LDAP database contiene nalmente diverse informazioni utili, pronte per
     essere usate. Questo paragrafo si focalizza su come con gurare un sistema Linux in modo che le
     diverse directories utilizzino il database LDAP.


     11.7.3.1 Come con gurare NSS

     Il sistema NSS (Name Service Switch, per maggiori dettagli andate a leggere la casella di testo
     "Database di sistema e NSS" a pagina 158) è un sistema modulare per de nire o recuperare le
     informazioni dalle directories di sistema. Per utilizzare l’LDAP come sorgente di dati per l’NSS, è
     necessario installare il pacchetto libnss-ldap. La sua installazione pone diverse domande; le
     risposte sono riassunte nella Tavola 11.2.

      Domande                                                                                   Risposte
      LDAP server Uniform Resource Identi er                                                    ldap://ldap.falcot.com
      Distinguished name of the search base (Il                                                 dc=falcot,dc=com
      Distinguished name della search base)
      LDAP version to use (versione LDAP da                                                     3
      utilizzare)
      Does the LDAP database require login? (LDAP                                               no
      database necessita del login?)
      Special LDAP privileges for root (Concedere a                                             yes
      root i diritti speciali per l’LDAP
      Make the con guration le readable/write-                                                  no
      able by its owner only (Concedere i permessi
      di scrittura lettura del le di con gurazione
      solo al suo owner)
      LDAP account for root (l’account root)                                                    cn=admin,dc=falcot,dc=com
      LDAP root account password                                                                administrative password

                                                                   Tavola 11.2 Con gurazione del pacchetto libnss-ldap

     Dopo dovrete modi care il le /etc/nsswitch.conf per con gurare l’NSS in modo che utilizzi
     l’installazione recente.

                                                                        Esempio 11.26 Il le /etc/nsswitch.conf

     # /etc/nsswitch.con

     # Example configuration of GNU Name Service Switch functionality
     # If you have the ‘glibc-doc’ and ‘info’ packages installed, try
     # ‘info libc ”Name Service Switch”’ for information about this file

     passwd: ldap compa
     group: ldap compa
     shadow: ldap compa

     hosts: files dns lda
     networks: ldap file




                          TDAH_1.0                      Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 287
#

      fi
           fi
                fi
                     fi
                     fi
                          t

                               t

                               t

                                    fi
                                         fi
                                         f

                                         s

                                              p

                                                   fi
                                                         fi
                                                              fi
                                                                   fi
                                                                             fi
                                                                                    fi
                                                                                           fi
                                                                                                         fi
                                                                                                                   :

                                                                                                                   .

                                                                                                                        .

               protocols: ldap db file
               services: ldap db file
               ethers: ldap db file
               rpc: ldap db file

               netgroup: ldap file

               Il modulo ldap viene incluso sistematicamente prima degli altri, quindi verrà interpellato per primo.
               Fa eccezione l’hosts service dal momento che il server LDAP dovrà consultare preventivamente il
               DNS (per la risoluzione di ldap.falcot.com). Senza questa precauzione, potrebbe essere richiesta
               al server LDAP una hostname query e tale richiesta potrebbe innescare una name resolution per
               l’LDAP server no a determinare un loop in nito.
               Se desiderate che l’LDAP server assuma il ruolo di “authoritative” (e non tenga conto dei local les
               utilizzati dal modulo files) potrete con gurarne i servizi attraverso la sintassi:

               service:ldap [NOTFOUND=return] files.

               Se l’entry richiesta non troverà corrispondenza nel database LDAP, la query restituirà "not existing"
               anche se di fatto la risorsa è presente in uno dei local les; i local les verranno invece utilizzati solo
               quando il servizio LDAP è inattivo.


               11.7.3.2 Come con gurare PAM

               Questo paragrafo descrive la con gurazione di PAM (andate a leggere la casella di testo "/etc/
               environment e /etc/default/local" a pagina 147) necessaria alle applicazioni per l’esecuzione
               delle autenticazioni per il database LDAP.


                    ATTENZIONE                                 La modi ca della con gurazione standard di PAM attuata dai vari programmi è
                Autenticazione                                 un’operazione piuttosto dolente. Se uno sbaglio compromette l’autenticazione sarà
                                                               impossibile effettuare il login. Pertanto per precauzione mantenete aperta la shell
                non funzionante                                di root. Dopodiché se la con gurazione determina degli errori potrete correggerli
                                                               con il minimo sforzo.



               Il modulo LDAP per PAM è incluso nel pacchetto Debian libpam-ldap. L’installazione del pacchetto
               prevede la richiesta di alcune domande simili a quelle di libnss-ldap; alcuni parametri di
               con gurazione (tra cui l'URI del server LDAP) sono condivisi con il pacchetto libnss-ldap. Le
               risposte sono riassunte nella Tavola 11.3.
               L'installazione di libpam-ldap modi ca automaticamente la con gurazione prede nita di PAM
               inclusa nei les /etc/pam.d/common-auth, /etc/pam.d/common-password e /etc/pam.d/
               common-account. Il pacchetto effettua il suddetto meccanismo per mezzo del tool pam-auth-update
               (incluso nel pacchetto libpam-runtime). L'amministratore può al bisogno eseguire il
               summenzionato tool per attivare e disattivare i moduli PAM.




               Pagina 288 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
     fi
          fi
                 fi
                      fi
                       fi
                            s

                                 s

                                      fi
                                           s

                                                s

                                                     s

                                                          fi
                                                                fi
                                                                     fi
                                                                          fi
                                                                                  fi
                                                                                               fi
                                                                                                fi
                                                                                                                   fi
                                                                                                                                fi
                    Domande                                                                                           Risposte
                    Allow LDAP admin account to behave like local                                                     Si. Ciò consente di utilizzare il comando
                    root? (Consentire all’account LDAP admin di                                                       passwd per cambiare le passwords archiviate
                    poter agire con gli stessi diritti di local root?)                                                nell’LDAP database.
                    Does the LDAP database require logging in?                                                        no
                    (LDAP database necessita del login?)
                    LDAP account for root (L’account LDAP per il                                                      cn=admin,dc=falcot,dc=com
                    ruolo di root)
                    LDAP root account password (La password                                                           La LDAP database administrative password
                    dell’account root dell’LDAP)
                    Local encryption algorithm to use for pass-                                                       crypt
                    words (L’algoritmo locale per criptare le
                    passwords)




                                                                         Tavola 11.3 Con gurazione del libpam-ldap


               11.7.3.3 Come proteggere lo Scambio Dati di LDAP

               Per impostazione prede nita il protocollo LDAP transita sulla rete come testo in chiaro [non
               crittografato]. Ciò signi ca che le passwords crittografate possono essere intercettate sulla rete e
               decriptate attraverso un attacco a dizionario. Per scongiurare ciò occorre utilizzare un extra
               encryption layer; questo paragrafo tratta l’attivazione del layer in questione.

               11.7.3.3.1 Con gurazione lato server Il primo passo è creare una coppia di chiavi (una chiave
               pubblica ed una chiave privata) per il server LDAP. A tale scopo gli amministratori della Falcot Corp
               riutilizzano easy-rsa (andate a leggere il paragrafo 10.2.1.1, "Infrastruttura a chiave pubblica:
               easy-rsa" a pagina 224). L’esecuzione di ./build-server-key ldap.falcot.com restituisce
               diverse domande ordinarie (location, organization, ecc.). Dovrete immettere in risposta alla
               domanda “common name” il fully-quali ed hostname del server LDAP; in questo caso
               ldap.falcot.com.
               Il precedente comando ha generato un certi cato nel le keys/ldap.falcot.com.crt e la chiave
               privata corrispondente è conservata in keys/ldap.falcot.com.key.
               Dal momento che queste chiavi sono state installate nella loro posizione standard, dovrete
               assicurarvi che il le della chiave privata sia leggibile dal server LDAP, in esecuzione sotto l'identità
               dell'utente openldap:

               # adduser openldap ssl-cer
               Adding user ‘openldap’ to group ‘ssl-cert’ ..
               Adding user openldap to group ssl-cer
               Done
               # mv keys/ldap.falcot.com.key /etc/ssl/private/ldap.falcot.com.key
               # chown root:ssl-cert /etc/ssl/private/ldap.falcot.com.ke
               # chmod 0640 /etc/ssl/private/ldap.falcot.com.ke
               # mv newcert.pem /etc/ssl/certs/ldap.falcot.com.pe

               Dovrete con gurare anche il demone slapd af nché utilizzi le suddette chiavi di crittogra a. La
               con gurazione del server LDAP è gestita dinamicamente: può essere aggiornata con le normali
               operazioni LDAP sull’object hierarchy cn = config ed i costanti aggiornamenti del server in /
               etc/ldap/slapd.d che rendono persistente la con gurazione. [L’object hierarchy si riferisce alla
               discendenza gerarchizzata di un object. In pratica e molto genericamente sono degli objects che
               de niscono le caratteristiche di un object (a cui sono sono correlati).
               Il termine inglese “location” genericamente signi ca in italiano “posizione”, ma nella manualistica
               alla stessa stregua del termine inglese “implementation” viene italianizzato in “locazione” (ad
               esempio “la locazione dei les”). Questi termini sono dei neologismi che possono indurre confusione,
               in quanto per locazione in italiano si intende un tipo di contratto. Allo stesso tempo “location” in
               informatica può non signi care semplicemente “posizione”, bensì può riferirsi a tutte quelle
               informazioni che individuano la posizione. Un altro esempio è il neologismo “localizzazione” che in
               italiano signi ca “essere situato in”, ma che in informatica può riferirsi alla traduzione di un
                                        TDAH_1.0         Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 289
fi
     fi
          .

               fi
                    fi
                         fi
                              fi
                                   fi
                                         fi
                                              fi
                                                   fi
                                                    fi
                                                          t

                                                               fi
                                                                    fi
                                                                         fi
                                                                              fi
                                                                                   t

                                                                                        fi
                                                                                             fi
                                                                                                  fi
                                                                                                       .

                                                                                                            y

                                                                                                                 m

                                                                                                                              y

                                                                                                                                        

                                                                                                                                             fi
               documento. Insomma è palese la carenza di un linguaggio comune: lo preciso solo per rendere
               evidente la dif coltà per chi traduce ed onde evitare le critiche del saccente di turno.]

               Per aggiornare la con gurazione dovrete usare il tool ldapmodify:

                                                                       Esempio 11.27 Con gurazione di slapd per supportare la crittogra a

               # cat >ssl.ldif <<EN
               dn: cn=confi
               changetype: modif
               add: olcTLSCertificateFil
               olcTLSCertificateFile: /etc/ssl/certs/ldap.falcot.com.pem

               add: olcTLSCertificateKeyFil
               olcTLSCertificateKeyFile: /etc/ssl/private/ldap.falcot.com.ke

               EN
               # ldapmodify -Y EXTERNAL -H ldapi:/// -f ssl.ldi
               SASL/EXTERNAL authentication starte
               SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
               SASL SSF:
               modifying entry ”cn=config


                         STRUMENTI                                                    ldapvi consente di visualizzare un LDIF output di qualsiasi parte della directory
                                TOOLS                                                 LDAP, di effettuare le modi che in un editor di testo e di mettere in atto le
                    ldapvi il tool per                                                opportune LDAP operations.
                    modi care un                                                      Quindi un metodo particolarmente pratico per aggiornare la con gurazione del
                                                                                      LDAP server è modi care la gerarchia cn=config.
                    LDAP directory
                                                                                      # ldapvi -Y EXTERNAL -h ldapi:/// -b cn=config




               L'ultimo passaggio per abilitare la crittogra a è modi care la variabile SLAPD_SERVICES nel le /
               etc/default/slapd. Per evitare qualsiasi rischio, occorre disattivare del tutto l’unsecured LDAP.


                                                                                                        Esempio 11.28 Il le /etc/default/slapd

               # Default location of the slapd.conf file or slapd.d cn=config directory. If
               # empty, use the compiled-in default (/etc/ldap/slapd.d with a fallback to
               # /etc/ldap/slapd.conf)
               SLAPD_CONF

               # System account to run the slapd server under. If empty the server
               # will run as root
               SLAPD_USER=”openldap

               # System group to run the slapd server under. If empty the server will
               # run in the primary group of its user




               Pagina 290 Il Manuale dell’Amministratore di Debian TDAH_1.0
-

-

     D

          fi
               0

               =

                     fi
                          g

                               fi
                                    fi
                                         fi
                                              fi
                                              y

                                                   .

                                                        fi
                                                             D

                                                             ”

                                                                  .

                                                                       e

                                                                            ”

                                                                                 e

                                                                                              fi
                                                                                                   d

                                                                                                           .

                                                                                                                fi
                                                                                                                     fi
                                                                                                                          fi
                                                                                                                               f

                                                                                                                                      

                                                                                                                                          y

                                                                                                                                                  

                                                                                                                                                       

                                                                                                                                                       

                                                                                                                                                           fi
                                                                                                                                                                 

                                                                                                                                                                      

          SLAPD_GROUP=”openldap

          # Path to the pid file of the slapd server. If not set the init.d script
          # will try to figure it out from $SLAPD_CONF (/etc/ldap/slapd.conf b
          # default
          SLAPD_PIDFILE

          # slapd normally serves ldap only on all TCP-ports 389. slapd can also
          # service requests on TCP-port 636 (ldaps) and requests via uni
          # sockets
          # Example usage
          # SLAPD_SERVICES=”ldap://127.0.0.1:389/ ldaps:/// ldapi:///”
          SLAPD_SERVICES=”ldaps:/// ldapi:///

          # If SLAPD_NO_START is set, the init script will not start or restar
          # slapd (but stop will still work). Uncomment this if you ar
          # starting slapd via some other means or if you don’t want slapd normally
          # started at boot
          #SLAPD_NO_START=

          # If SLAPD_SENTINEL_FILE is set to path to a file and that file exists,
          # the init script will not start or restart slapd (but stop will stil
          # work). Use this for temporarily disabling startup of slapd (when doing
          # maintenance, for example, or through a configuration management system)
          # when you don’t want to edit a configuration file.
          SLAPD_SENTINEL_FILE=/etc/ldap/noslap

          # For Kerberos authentication (via SASL), slapd by default uses the system
          # keytab file (/etc/krb5.keytab). To use a different keytab file
          # uncomment this line and change the path
          #export KRB5_KTNAME=/etc/krb5.keyta

          # Additional options to pass to slap
          SLAPD_OPTIONS=”

          11.7.3.3.2 Con gurazione lato client Sul lato client, è necessario modi care la con gurazione dei
          moduli libpam-ldap e libnss-ldap utilizzando un ldaps://URI.
          Anche i clients LDAP devono essere messi in grado di autenticare il server. In un'infrastruttura a
          chiave pubblica che rispetta lo standard X.509, i certi cati pubblici vengono rmati dalla chiave di
          una Certi cate Authority (CA). Dunque gli amministratori della Falcot Corp per mezzo di easy-rsa
          hanno creato una Certificate Authority (CA) per poi con gurare il sistema in modo che
          riconosca come sicura la CA della stessa Falcot Corp. Per ottenere ciò gli amministratori hanno
          caricato il certi cato CA in /usr/local/share/ca-certificates ed eseguito update-ca-
          certificates.




                                       TDAH_1.0   Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 291
fi
     )

     .

             fi
                  fi
                       =

                            :

                            ”

                                 1

                                      .

                                           ”

                                                       fi
                                                                 ”

                                                                 b

                                                                      d

                                                                      d

                                                                           .

                                                                                fi
                                                                                     fi
                                                                                           

                                                                                                  fi
                                                                                                        

                                                                                                       e

                                                                                                            fi
                                                                                                                 x

                                                                                                                      ,

                                                                                                                           fi
                                                                                                                                y

                                                                                                                                t

                                                                                                                                     l

                                                                                                                                           

                                                                                                                                                

                                                                                                                                                     

                                                                                                                                                     

                                                                                                                                                          

                                                                                                                                                          

                                                                                                                                                               

               # cp keys/ca.crt /usr/local/share/ca-certificates/falcot.cr
               # update-ca-certificate
               Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done.
               Running hooks in /etc/ca-certificates/update.d...
               Adding debian:falcot.pe
               done
               done

               In ne, potrete modi care anche il default LDAP URI ed il default base DN in /etc/ldap/
               ldap.conf utilizzati da diversi tools da riga di comando. In questo modo non avrete la necessità di
               digitare tali parametri da riga di comando.

                                                              Esempio 11.29 Il le /etc/ldap/ldap.conf


               # LDAP Default


               # See ldap.conf(5) for detail
               # This file should be world readable but not world writable

               BASE               dc=falcot,dc=co
               URI                ldaps://ldap.falcot.co

               #SIZELIMIT                             1
               #TIMELIMIT                             1
               #DEREF                                 neve

               # TLS certificates (needed for GnuTLS
               TLS_CACERT /etc/ssl/certs/ca-certificates.cr

               Questo capitolo descrive soltanto una minima parte dei softwares disponibili per servers; tuttavia la
               maggior parte dei servizi di rete più comuni sono stati trattati. Inoltre riteniamo sia giunto il
               momento di occuparci di argomenti più tecnici: ciò consentirà di approfondire nel dettaglio diversi
               concetti, attraverso la descrizione dei massive deployments e delle virtualizzazioni.


               11.8. Real-Time Communication Service

               I servizi Real-Time Communication (RTC) includono voce, video/webcam, messaggistica
               istantanea (instant messaging, IM) e desktop sharing. Questo capitolo introduce brevemente
               tre servizi necessari per mettere in piedi una RTC ovvero un server TURN, un server SIP ed un
               server XMPP. La Real-Time Communication Quick Start Guide include: sia spiegazioni chiare e
               dettagliate su come piani care, installare e gestire questi servizi, sia esempi speci ci per Debian.

                 http://rtcquickstart.org

               SIP e XMPP possono offrire le stesse funzionalità. SIP è leggermente più conosciuto per i servizi voce
               e video, mentre XMPP viene tradizionalmente utilizzato come protocollo di messaggistica istantanea
               (IM).




               Pagina 292 Il Manuale dell’Amministratore di Debian TDAH_1.0
#

#

     fi
          .

          .

                   fi
                        s

                             fi
                                  5

                                  2

                                       fi
                                       r

                                            m

                                                 s

                                                 m

                                                         s

                                                         m

                                                                )

                                                                         t

                                                                                .

                                                                                              t

                                                                                              .

                                                                                                        fi
                                                                                                              

In realtà entrambi i servizi possono essere utilizzati per ciascuna delle summenzionate nalità. Per
ottimizzare le opzioni di connettività, è consigliabile eseguirli tutti e due in parallelo.
Inoltre i suddetti servizi utilizzano certi cati X.509 sia per l’autenticazione, sia per ragioni di
riservatezza. Per maggiori dettagli su come crearli andate a leggere il paragrafo 10.2.1.1,
"Infrastruttura a chiave pubblica: easy-rsa" a pagina 224. In alternativa potrete trovare delle valide
spiegazioni in Real-Time Communication Quick Start Guide:

  http://rtcquickstart.org/guide/multi/tls.html

11.8.1. Impostazioni DNS per i servizi RTC

I servizi RTC richiedono i records DNS SRV e NAPTR. A seguire un esempio di una con gurazione
che può essere inserita nel zone le per falcot.com:

; the server where everything will ru
server1            IN     A      198.51.100.1
server1            IN     AAAA   2001:DB8:1000:2000::1

; IPv4 only for TURN for now, some clients are buggy with IPv6
turn-server IN A 198.51.100.1

; IPv4 and IPv6 addresses for SI
sip-proxy          IN     A      198.51.100.1
sip-proxy          IN     AAAA   2001:DB8:1000:2000::1

; IPv4 and IPv6 addresses for XMP
xmpp-gw            IN     A       198.51.100.1
xmpp-gw            IN     AAAA    2001:DB8:1000:2000::1

; DNS SRV and NAPTR for STUN /                                    TUR
_stun._udp IN SRV     0 1 3467                                    turn-server.falcot.com
_turn._udp IN SRV     0 1 3467                                    turn-server.falcot.com
@           IN NAPTR 10 0 ”s”                                     ”RELAY:turn.udp” ”” _turn._udp.falcot.com

; DNS SRV and NAPTR records for SI
_sips._tcp IN SRV     0 1 5061 sip-proxy.falcot.com
@           IN NAPTR 10 0 ”s” ”SIPS+D2T” ”” _sips._tcp.falcot.com

; DNS SRV records for XMPP Server and Client modes
_xmpp-client._tcp IN      SRV    5 0 5222 xmpp-gw.falcot.com
_xmpp-server._tcp IN      SRV    5 0 5269 xmpp-gw.falcot.com

11.8.2. TURN server

TURN è un servizio che supporta i clients sostenendo i NAT routers ed i rewalls, attraverso la
ricerca del metodo più ef ciente per comunicare con altri clients e ritrasmettendo i media streams
nei casi in cui non viene trovato un direct media path [in sostanza un percorso dedicato e diretto
per mezzo del quale due IP interni comunicano]. È consigliabile installare il server TURN prima di
qualunque altro servizio RTC offerto agli utenti nali.
TURN e il correlato protocollo ICE sono open standards [non esiste una de nizione univoca per
“open standard”. Sostanzialmente si tratta di un prodotto disponibile al pubblico a cui sono stati
associati dei diritti di proprietà intellettuale attraverso una licenza d’uso che impone diritti e doveri
alle parti interessate nel processo di realizzazione del prodotto ed ai terzi]. Per bene ciare a pieno
dei suddetti protocolli, massimizzare la connettività e ridurre al minimo l’user frustration, il
software dei clients deve essere compatibile. [L’user frustration o frustrazione dell’utente è un
fenomeno che fa parte insieme alla “rabbia” del “computer rage” (la collera durante l’interazione con
un computer), che può portare l’utente a fenomeni di violenza nei confronti di dispositivi informatici-
elettronici, sino a giungere a veri e propri reati penali]. Af nché l'algoritmo ICE sia ef ciente, il
server deve disporre di due indirizzi IPv4 pubblici.


         TDAH_1.0   Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 293
             fi
                     fi
                          fi
                               9

                                    fi
                                         P

                                              P

                                                   N

                                                   P

                                                        n

                                                             fi
                                                                      9

                                                                      9

                                                                      9

                                                                           fi
                                                                                :

                                                                                     .

                                                                                          .

                                                                                          .

                                                                                               9

                                                                                               9

                                                                                               9

                                                                                                    fi
                                                                                                         fi
                                                                                                              .

                                                                                                              .

                                                                                                                    

                                                                                                                        .

                                                                                                                             fi
                                                                                                                                  fi
                                                                                                                                       fi
                                                                                                                                            fi
                                                                                                                                                 .

     11.8.2.1 Installazione del TURN server

     Dovrete prima installare il pacchetto resiprocate-turn-server e poi modi care il le di con gurazione /
     etc/reTurn/reTurnServer.config. Immettete gli indirizzi IP del server.

     # your IP addresses go here
     TurnAddress = 198.51.100.1
     TurnV6Address = 2001:DB8:1000:2000::1
     AltStunAddress = 198.51.100.2
     # your domain goes here, it must match the value used
     # to hash your passwords if they are already hashed
     # using the HA1 algorithm
     AuthenticationRealm = myreal

     UserDatabaseFile = /etc/reTurn/users.tx
     UserDatabaseHashedPasswords = tru

     Riavviate il servizio.


     11.8.2.2 TURN gestione utenti

     Per gestire l’elenco utenti del server TURN utilizzate l'utilità htdigest.

     # htdigest /etc/reTurn/users.txt myrealm jo

     Dopo aver apportato le modi che al le /etc/reTurn/users.txt, dovrete inviare il segnale HUP al server per
     ricaricare (“reload” in inglese) il summenzionato le o attivare la funzionalità di ricaricamento automatico in /
     etc/reTurn/reTurnServer.config.

     [Il segnale HUP o SIGHUP (“signal hang up”) è un segnale che può avere diversi usi. Può essere inviato ad
     esempio ad un processo quando la sua gestione da terminale è conclusa oppure per riavviare un demone per far
     sì che quest’ultimo tenga in considerazione al riavvio della modi ca di un le di con gurazione.

     kill -HUP <processID
     ]

     11.8.3. SIP Proxy Server [Session Initiation Protocol]

     Un SIP proxy server gestisce le connessioni SIP in entrata e in uscita; SIP è un protocollo impiegato da
     organizzazioni, gestori di SIP trunking [servizi VoIP], SIP PBXes [Private Branch eXchange - basata sul
     protocollo SIP, è una rete telefonica privata (o centralino) che consente ai suoi utenti di comunicare
     internamente ed esternamente] tra cui Asterisk [software libero che consente di implementare una PBX], SIP
     phones (hardware), softphones (software basati sul protocollo SIP) ed applicazioni WebRTC [tecnologia basata
     su HTML5 e JavaScript che consente ai browsers di effettuare in tempo reale videochat].
     Si consiglia vivamente di installare e con gurare il SIP proxy prima della con gurazione di un SIP PBX (private
     branch exchange). Il SIP proxy normalizza gran parte del traf co in arrivo al PBX e garantisce una migliore
     connettività e resilienza. [Normalizzazione è un termine tecnico prettamente matematico che viene impiegato
     anche nella statistica. Si tratta sostanzialmente e molto genericamente di un metodo che consente di tradurre
     dei dati sempli candoli per mezzo di una costante per ottenere una loro risoluzione o conversione in un altro
     formato. Nel caso di un database la normalizzazione è una riorganizzazione dei dati di un database af nché la
     ridondanza dei dati sia ridotta e gli stessi dati possano essere conservati in un unica posizione. La resilienza
     invece è la capacità di mantenere un dato livello di servizio, quali cato come minimo o accettabile, nonostante il
     sopraggiungere di guasti o di altre esternalità.]


     11.8.3.1 Installazione del SIP proxy

     Dovrete prima installare il pacchetto repro. L’impiego del pacchetto jessie-backports è caldamente
     raccomandato perché vi consentirà di usufruire degli ultimi aggiornamenti che migliorano la connettività e la
     resilienza.
     Poi modi cate il le di con gurazione /etc/repro/repro.config ed aggiungete gli indirizzi IP del server.
     L'esempio seguente mostra come con gurare sia i servizi SIP, sia i servizi WebSocket/WebRTC utilizzando TLS,
     IPv4 e IPv6:




     Pagina 294 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
      fi
           fi
                 >

                      fi
                           fi
                                :

                                     9

                                          :

                                               m

                                                    fi
                                                         0

                                                              fi
                                                                   fi
                                                                        e

                                                                             9

                                                                                  t

                                                                                       fi
                                                                                            e

                                                                                                 fi
                                                                                                      fi
                                                                                                            

                                                                                                                fi
                                                                                                                      

                                                                                                                          fi
                                                                                                                               fi
                                                                                                                               fi
                                                                                                                                    fi
                                                                                                                                         fi
                                                                                                                                              fi
                                                                                                                                                   fi
# Transport1 will be for SIP over TLS connection
# We use port 5061 here but if you have clients connecting fro
# locations with firewalls you could change this to listen on port 443
Transport1Interface = 198.51.100.19:506
Transport1Type = TL
Transport1TlsDomain = falcot.co
Transport1TlsClientVerification = Optiona
Transport1RecordRouteUri = sip:falcot.com;transport=TLS
Transport1TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport1TlsCertificate = /etc/ssl/public/falcot.com.pe

# Transport2 is the IPv6 version of Transport1
Transport2Interface = 2001:DB8:1000:2000::19:5061
Transport2Type = TL
Transport2TlsDomain = falcot.com
Transport2TlsClientVerification = Optional
Transport2RecordRouteUri = sip:falcot.com;transport=TLS
Transport2TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport2TlsCertificate = /etc/ssl/public/falcot.com.pe

# Transport3 will be for SIP over WebSocket (WebRTC) connections
# We use port 8443 here but you could use 443 instead
Transport3Interface = 198.51.100.19:844
Transport3Type = WS
Transport3TlsDomain = falcot.co
# This would require the browser to send a certificate, but browsers
# don’t currently appear to be able to, so leave it as None:
Transport3TlsClientVerification = Non
Transport3RecordRouteUri = sip:falcot.com;transport=WSS
Transport3TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport3TlsCertificate = /etc/ssl/public/falcot.com.pe

# Transport4 is the IPv6 version of Transport3
Transport4Interface = 2001:DB8:1000:2000::19:8443
Transport4Type = WS
Transport4TlsDomain = falcot.com
Transport4TlsClientVerification = None
Transport4RecordRouteUri = sip:falcot.com;transport=WSS
Transport4TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport4TlsCertificate = /etc/ssl/public/falcot.com.pe

# Transport5: this could be for TCP connections to an Asterisk server
# in your internal network. Don’t allow port 5060 through the external
# firewall
Transport5Interface = 198.51.100.19:506
Transport5Type = TC
Transport5RecordRouteUri = sip:198.51.100.19:5060;transport=TCP




       TDAH_1.0   Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 295
.

         S

         S

         S

         S

         P

                       fi
                            m

                            m

                                  

                                  

                                      e

                                            

                                                1

                                                3

                                                0

                                                     l

                                                           

                                                                

                                                                

                                                                    s

                                                                          

                                                                          

                                                                               

                                                                                    

                                                                                    

                                                                                    

                                                                                    

                                                                                        m

                                                                                        m

                                                                                        m

                                                                                        m

                                                                                              

                                                                                                   

                                                                                                   

                                                                                                   

                                                                                                   

                                                                                                       m

                                                                                                             

                                                                                                                  

                                                                                                                       

                                                                                                                            

                                                                                                                            

               HttpBindAddress = 198.51.100.19, 2001:DB8:1000:2000::19
               HttpAdminUserFile = /etc/repro/users.tx

               RecordRouteUri = sip:falcot.com;transport=tls
               ForceRecordRouting = tru
               EnumSuffixes = e164.arpa, sip5060.net, e164.org
               DisableOutbound = fals
               EnableFlowTokens = tru
               EnableCertificateAuthenticator = Tru

               Per gestire la password dell'amministratore per l'interfaccia Web dovrete impiegare l’utility
               htdigest. Il suo username dovrà essere admin ed il realm name dovrà corrispondere al valore
               de nito in repro.config.

               # htdigest /etc/repro/users.txt repro admi

               Riavviate il servizio per utilizzare la nuova con gurazione.


               11.8.3.2 Come gestire il SIP proxy.

               Attraverso l’interfaccia web recatevi su http://sip-proxy.falcot.com:5080 per completare la
               con gurazione inserendo i domini, i local users ed i static routes.
               Innanzitutto dovrete inserire il local domain. Il processo dovrà essere riavviato ogniqualvolta
               abbiate aggiunto o rimosso i domini dall'elenco.
               Il proxy è in condizione di instradare le chiamate tra i local users ed i full SIP address, ma la routing
               con guration è necessaria se occorre l’override (trad. lett. “sostituzione”) delle funzionalità
               prede nite; ad esempio, per l’identi cazione dei numeri di telefono, per aggiungere un pre sso e per
               instradarli verso un SIP provider.


               11.8.4. XMPP Server

               Un XMPP server gestisce la connettività tra i local XMPP users e gli users XMPP di altri domini sulla
               rete pubblica (internet).


                 PROPRIETÀ DI LINGUAGGIO                                     A volte XMPP viene citato con il nome di Jabber. In realtà, Jabber è un
                XMPP o Jabber                                                marchio mentre XMPP è il nome uf ciale di un protocollo standard.


               Prosody è un noto XMPP server ed è af dabile sui servers Debian.


               11.8.4.1 Installazione del XMPP server.

               Installate il pacchetto prosody. Il pacchetto jessie-backport include gli ultimi aggiornamenti in
               grado di ottimizzare la connettività e la resilienza, pertanto ne è raccomandata l’installazione.
               Dovrete inoltre revisionare il le di con gurazione /etc/prosody/prosody.cfg.lua. Innanzitutto
               occorre inserire i JIDs degli utenti con titolarità dei diritti per la gestione del server.




               Pagina 296 Il Manuale dell’Amministratore di Debian TDAH_1.0
fi
     fi
     fi
          fi
                                e

                                e

                                     fi
                                          e

                                               fi
                                                    fi
                                                         fi
                                                              fi
                                                                   e

                                                                        fi
                                                                              t

                                                                                   n

                                                                                         

                                                                                              

                                                                                                     

                                                                                                                           fi
admins = { ”joe@falcot.com”

Poi avrete bisogno di un le di con gurazione per ciascun dominio. Come modello potrete utilizzare
/etc/prosody/conf.cfg/example.com.cfg.lua . A seguire il le falcot.com.cfg.lua creato
dagli amministratori del Falcot Corp:

VirtualHost ”falcot.com
        enabled = tru
        ssl =
               key = ”/etc/ssl/private/falcot.com-key.pem”;
               certificate = ”/etc/ssl/public/falcot.com.pem”;


Per attivare il dominio, dovrete creare un symlink in /etc/prosody/conf.d/:

# ln -s /etc/prosody/conf.avail/falcot.com.cfg.lua /etc/prosody/conf.d

Riavviate il servizio per utilizzare la nuova con gurazione.


11.8.4.2 Come gestire il server XMPP

Lo XMPP server può essere gestito attraverso l’utility da riga di comando prosodyctl. Ad esempio,
per aggiungere l'account dell’amministratore speci cato in /etc/prosody/prosody.cfg.lua:

# prosodyctl adduser joe@falcot.co

Troverete maggiori dettagli su come personalizzare la con gurazione nella pagina web Prosody
online documentation (http://prosody.im/doc/con gure).


11.8.5. Come eseguire i servizi sul port 443

Alcuni amministratori preferiscono eseguire tutti i servizi RTC sul port 443. La ragione è consentire
agli utenti di connettersi da postazioni remote, tra cui hotels ed aeroporti, in cui solitamente gli altri
ports sono bloccati o il traf co Internet viene instradato tramite HTTP proxy servers.
Per poter mettere in pratica quanto appena espresso, ad ogni servizio (SIP, XMPP e TURN) deve
essere assegnato un indirizzo IP diverso. Inoltre tutti i servizi possono comunque essere messi in
esecuzione sullo stesso host in quanto Linux consente la gestione di indirizzi IP multipli su un
singolo host. Il port number 443 deve essere speci cato sia nei les di con gurazione di ciascun
processo, sia nei DNS SRV records.




                TDAH_1.0          Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 297
      {

           }

                  fi
                       e

                        fi
                             ”

                                     fi
                                          }

                                               fi
                                                    m

                                                         fi
                                                              fi
                                                                   fi
                                                                        fi
                                                                             fi
                                                                                  fi
                                                                                       fi
                                                                                            fi
                                                                                                  

                                                                                                       

                                                                                                           /

               11.8.6. Come aggiungere un servizio WebRTC.

               La Falcot Corp desidera consentire alla clientela di poter effettuare le chiamate telefoniche
               direttamente dal sito web. Pertanto gli amministratori della Falcot Corp decidono di utilizzare anche
               WebRTC e di includerlo nel disaster recovery plan, in modo che il personale qualora dovesse
               veri carsi una emergenza possa, attraverso i web browsers, loggarsi da casa nel sistema telefonico
               della società e svolgere le proprie mansioni normalmente.


                         IN PRATICA                               Per iniziare a conoscere WebRTC, ci sono diversi siti che contengono dimostrazioni e
                    Scoprire WebRTC                               test facilities.
                                                                    http://www.sip5060.net/test-calls.



               WebRTC è una tecnologia in continua evoluzione, pertanto è fondamentale che utilizziate i pacchetti
               Jessie-Backport o delle distribuzioni Testing.
               JSCommunicator è un software WebRTC phone non brandizzato, che non richiede server-side
               scripting come php. [Il server-side scripting è una tecnica di web development che, in
               alternativa ad una pagina web statica, supporta un’interfaccia personalizzata per ciascun utente].
               Viene realizzato esclusivamente attraverso HTML, CSS e JavaScript. Molti altri servizi e moduli
               WebRTC di avanzati web publishing frameworks si basano su JSCommunicator. [Molto
               genericamente il web publishing framework è un software che può essere corretto, personalizzato
               o migliorato dagli stessi utenti tramite codice].

                    http://jscommunicator.org

               Attraverso il pacchetto jscommunicator-web-phone potrete installare rapidamente un WebRTC
               phone su un sito web. Serve soltanto un SIP proxy che includa il WebSocket transport [un
               protocollo SIP]. Il paragrafo 11.8.3.1, “Installazione del SIP proxy” a pag. 294 include tutte le
               informazioni necessarie per attivare su un repro SIP proxy il protocollo WebSocket transport.
               Una volta installato, jscommunicator-web-phone può essere utilizzato in diversi modi. Una delle
               strategie più semplici è includere o copiare la con gurazione di /etc/jscommunicator-web-
               phone/apache.conf nella con gurazione di un Apache virtual host.
               Una volta disponibili i web-phone les sul web server, dovrete personalizzare il le /etc/
               jscommunicator-web-phone/config.js in modo che punti al Turn server ed al SIP server. A
               seguire un esempio di quanto appena espresso:

               JSCommSettings =

                    // Web server environmen
                    webserver:
                      url_prefix: null       // If set, prefix used to construct sound/ URL
                    }

                    // STUN/TURN media relay
                    stun_servers: []
                    turn_servers:
                      { server:”turn:turn-server.falcot.com?transport=udp”, username:”joe”, password:”
                          -> j0Ep455d”
               ]
               // WebSocket connectio
               websocket:
                   // Notice we use the falcot.com domain certificate and port 8443




               Pagina 298 Il Manuale dell’Amministratore di Debian TDAH_1.0
,

     ,

          fi
               {

                     {

                          [

                               {

                                    ,

                                         }

                                              n

                                                   t

                                                   s

                                                        fi
                                                             fi
                                                                                fi
                                                                                                                 fi
                                                                                                                      s

                                                                                                                                    

                         // This matches the Transport3 and Transport4 example i
                         // the falcot.com repro.config fil
               servers: ’wss://falcot.com:8443’
               connection_recovery_min_interval: 2
               connection_recovery_max_interval: 3
          },

          ...

          Tipicamente i click-to-call web sites impiegano il server-side scripting per generare dinamicamente il
           le config.js. Il codice sorgente di DruCall (http://drucall.org) mostra come renderlo possibile
          con PHP.




                     TDAH_1.0   Capitolo XI - Servizi di Rete: Post x, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN Pagina 299
fi
      

                                     fi
                                          ,

                                               0

                                               ,

                                                         e

                                                                                     n

          Parole chiave
RAID
LVM
FAI
Preeseeding
Monitoring
Virtualizzazione
Xen
LXC
